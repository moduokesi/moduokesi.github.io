<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><link rel="icon" href="/images/logo.png"><title>常见的设计模式 | Modox&#39;s blog</title><meta name="author" content="Modox"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="robots" content="index,follow"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="format-detection" content="telphone=no, email=no"><meta name="keywords" content="学习笔记, 设计模式"><meta name="description" content="单例模式 懒汉式 通常使用双重校验+锁的方式实现 volatile关键字可防止指令重排，比如创建一个对象，JVM会分为三步：   为singleton分配内存空间 初始化singleton对象 将singleton指向分配好的内存空间   指令重排：JVM在保证最终结果正确的情况下，可以不按照程序编码的顺序执行语句，尽可能提高程序的性能 而volatile关键字会防止指令重"><meta property="og:type" content="article"><meta property="og:title" content="常见的设计模式"><meta property="og:url" content="https://moduokesi.top/2024/02/08/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/index.html"><meta property="og:site_name" content="Modox&#39;s blog"><meta property="og:description" content="单例模式 懒汉式 通常使用双重校验+锁的方式实现 volatile关键字可防止指令重排，比如创建一个对象，JVM会分为三步：   为singleton分配内存空间 初始化singleton对象 将singleton指向分配好的内存空间   指令重排：JVM在保证最终结果正确的情况下，可以不按照程序编码的顺序执行语句，尽可能提高程序的性能 而volatile关键字会防止指令重"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://moduokesi.top/images/logo.png"><meta property="article:published_time" content="2024-02-08T03:22:40.000Z"><meta property="article:modified_time" content="2024-02-22T03:22:44.098Z"><meta property="article:author" content="Modox"><meta property="article:tag" content="学习笔记"><meta property="article:tag" content="设计模式"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://moduokesi.top/images/logo.png"><link rel="alternate" href="atom.xml" type="application/atom+xml"><link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"><link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme:dark)"><script src="/js/kr-dark.min.js"></script><link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"><link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"><link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"><link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"><link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script><script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script><style>.kratos-cover.kratos-cover-2{background-image:url(/images/banner.webp)}@media(min-width:768px){body.custom-background{background-image:url(/images/bg.webp)}}</style><meta name="generator" content="Hexo 6.2.0"></head><body class="custom-background"><div id="kratos-wrapper"><div id="kratos-page"><div id="kratos-header"><header id="kratos-desktop-topnav" class="kratos-topnav"><div class="container"><div class="nav-header"><nav id="kratos-menu-wrap"><ul id="kratos-primary-menu" class="sf-menu"><li><a href="/"><i class="fa fa-home"></i> 首页</a></li><li><a href="/archives/"><i class="fa fa-file"></i> 档案馆</a></li><li><a><i class="fa fa-paw"></i> 友站</a><ul class="sub-menu"><li><a target="_blank" rel="noopener" href="https://penty7710.github.io/">pety's blog</a></li></ul></li><li><a><i class="fa fa-link"></i> 链接</a><ul class="sub-menu"><li><a target="_blank" rel="noopener" href="https://gitee.com/moduokesi_admin">gitee</a></li><li><a target="_blank" rel="noopener" href="https://github.com/moduokesi">github</a></li></ul></li></ul></nav></div></div></header><header id="kratos-mobile-topnav" class="kratos-topnav"><div class="container"><div class="color-logo"><a href="/">Modox&#39;s blog</a></div><div class="nav-toggle"><a class="kratos-nav-toggle js-kratos-nav-toggle"><i></i></a></div></div></header></div><div class="kratos-start kratos-hero-2"><div class="kratos-cover kratos-cover-2 text-center"><div class="desc desc2 animate-box"><a href="/"><h2>Modox&#39;s blog</h2><br><span></span></a></div></div></div><div id="kratos-blog-post"><div class="container"><div id="main" class="row"><section class="col-md-8"><article itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://moduokesi.top/2024/02/08/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/"><div class="kratos-hentry kratos-post-inner clearfix"><header class="kratos-entry-header"><h1 class="kratos-entry-title text-center" itemprop="name headline">常见的设计模式</h1><ul class="kratos-post-meta text-center"><li><time datetime="2024-02-08T03:22:40.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-02-08</time></li><li itemprop="author" itemscope itemtype="https://schema.org/Person"><i class="fa fa-user"></i> 作者 <span itemprop="name">Modox</span></li><li><i class="fa fa-edit"></i> ~20.07K 字</li></ul></header><div class="kratos-post-content"><div id="expire-alert" class="alert alert-warning hidden" role="alert"><div class="icon"><i class="fa fa-warning"></i></div><div class="text"><p>本文最后编辑于 <time datetime="1708572164098"></time> 前，其中的内容可能需要更新。</p></div></div><div class="kratos-post-inner-toc toc-div-class"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.</span> <span class="toc-text">单例模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%87%92%E6%B1%89%E5%BC%8F"><span class="toc-number">1.1.</span> <span class="toc-text">懒汉式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A5%BF%E6%B1%89%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">饿汉式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.</span> <span class="toc-text">工厂模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-number">3.</span> <span class="toc-text">代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"><span class="toc-number">4.</span> <span class="toc-text">策略模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F"><span class="toc-number">5.</span> <span class="toc-text">模板方法模式</span></a></li></ol></div><hr><div itemprop="articleBody"><h2 id="单例模式">单例模式</h2><h3 id="懒汉式">懒汉式</h3><p>通常使用<strong>双重校验+锁</strong>的方式实现</p><p><strong>volatile</strong>关键字可防止指令重排，比如创建一个对象，JVM会分为三步：</p><blockquote><ol type="1"><li><p>为singleton分配内存空间</p></li><li><p>初始化singleton对象</p></li><li><p>将singleton指向分配好的内存空间</p></li></ol></blockquote><p>指令重排：<strong>JVM在保证最终结果正确的情况下，可以不按照程序编码的顺序执行语句，尽可能提高程序的性能</strong></p><p>而<strong>volatile</strong>关键字会防止指令重排，从而保证线程安全。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> Singleton singleton;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123;  <span class="comment">// 线程A和线程B同时看到singleton = null，如果不为null，则直接返回singleton</span></span><br><span class="line">            <span class="keyword">synchronized</span>(Singleton.class) &#123; <span class="comment">// 线程A或线程B获得该锁进行初始化</span></span><br><span class="line">                <span class="keyword">if</span> (singleton == <span class="literal">null</span>) &#123; <span class="comment">// 其中一个线程进入该分支，另外一个线程则不会进入该分支</span></span><br><span class="line">                    singleton = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="饿汉式">饿汉式</h3><p>饿汉式在类加载时就创建好了对象，程序调用时可直接返回对象。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Singleton</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Singleton</span> <span class="variable">singleton</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span>&#123;&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> singleton;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="工厂模式">工厂模式</h2><p>对于接口存在多个实现类时，如果使用if-else语句进行实例化接口的操作，不利于代码扩展，如果换用其他实现类很麻烦。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line">   <span class="keyword">void</span> <span class="title function_">executeCode</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="comment">// 接口实例化</span></span><br><span class="line">       <span class="type">CodeSandbox</span> <span class="variable">codeSandbox</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">RemoteCodeSandbox</span>();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure><p>使用静态工厂模式可以灵活切换实现类，提高通用性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 代码沙箱工厂（根据字符串参数创建指定的代码沙箱实例）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeSandboxFactory</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 创建代码沙箱示例</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> type 沙箱类型</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> CodeSandbox <span class="title function_">newInstance</span><span class="params">(String type)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;example&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExampleCodeSandbox</span>();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;remote&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RemoteCodeSandbox</span>();</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&quot;thirdParty&quot;</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThirdPartyCodeSandbox</span>();</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ExampleCodeSandbox</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这样只需调用工厂类的静态方法，传入指定参数即可实例化对象。</p><h2 id="代理模式">代理模式</h2><p>实现原理：</p><ol type="1"><li>实现被代理的接口</li><li>通过构造函数接收一个被代理的接口实现类</li><li>调用被代理的接口实现类，在调用前后增加对应的操作</li></ol><p>比如，我们需要在调用代码沙箱前，输出请求参数日志；在代码沙箱调用后，输出响应结果日志，便于管理员去分析数据。</p><p>可以使用代理模式，提供一个<strong>Proxy</strong>，来增强代码沙箱的能力（代理模式的作用就是增强能力）</p><p>原本：需要用户自己去调用多次</p><p><img src="https://modox.oss-cn-hangzhou.aliyuncs.com/img/202402181536763.png"></p><p>使用代理后：不仅不用改变原本的代码沙箱实现类，而且对调用者来说，调用方式几乎没有改变，也不需要在每个调用沙箱的地方去写统计代码。</p><p><img src="https://modox.oss-cn-hangzhou.aliyuncs.com/img/202402181538503.png"></p><p>代理类：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CodeSandboxProxy</span> <span class="keyword">implements</span> <span class="title class_">CodeSandbox</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CodeSandbox codeSandbox;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CodeSandboxProxy</span><span class="params">(CodeSandbox codeSandbox)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.codeSandbox = codeSandbox;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExecuteCodeResponse <span class="title function_">executeCode</span><span class="params">(ExecuteCodeRequest executeCodeRequest)</span> &#123;</span><br><span class="line">        log.info(<span class="string">&quot;代码沙箱请求信息：&quot;</span> + executeCodeRequest.toString());</span><br><span class="line">        <span class="type">ExecuteCodeResponse</span> <span class="variable">executeCodeResponse</span> <span class="operator">=</span> codeSandbox.executeCode(executeCodeRequest);</span><br><span class="line">        log.info(<span class="string">&quot;代码沙箱响应信息：&quot;</span> + executeCodeResponse.toString());</span><br><span class="line">        <span class="keyword">return</span> executeCodeResponse;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使用方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CodeSandbox</span> <span class="variable">codeSandbox</span> <span class="operator">=</span> CodeSandboxFactory.newInstance(type);</span><br><span class="line">codeSandbox = <span class="keyword">new</span> <span class="title class_">CodeSandboxProxy</span>(codeSandbox);</span><br></pre></td></tr></table></figure><h2 id="策略模式">策略模式</h2><p>我们的判题策略可能会有很多种，比如: 我们的代码沙箱本身执行程序需要消耗时间，这个时间可能不同的编程语 言是不同的，比如沙箱执行 Java 要额外花 10 秒。</p><p>我们可以采用策略模式，针对不同的情况，定义独立的策略，便于分别修改策略和维护。而不是把所有的判题逻 辑、if ... else ...代码全部混在一起写.</p><ol type="1"><li>定义一个策略接口，让代码更通用化</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">JudgeStrategy</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行判题</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> judgeContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    JudgeInfo <span class="title function_">doJudge</span><span class="params">(JudgeContext judgeContext)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2" type="1"><li>定义判题上下文对象，用于定义在策略中传递的参数 (可以理解为一种 DTO)</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 上下文（用于定义在策略中传递的参数）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JudgeContext</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> JudgeInfo judgeInfo;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; inputList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; outputList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;JudgeCase&gt; judgeCaseList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Question question;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> QuestionSubmit questionSubmit;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3" type="1"><li>实现接口，实现各种判题策略</li></ol><blockquote><p>但是，如果选择某种判题策略的过程比较复杂，如果都写在调用判题服务的代码中，代码会越来越复杂，会有大量 if ... else ...，所以建议单独编写一个判断策略的类。</p></blockquote><ol start="4" type="1"><li>定义JudgeManager，目的是尽量简化对判题功能的调用，让调用方写最少的代码、调用最简单。对于判题 策略的选取，也是在JudgeManager 里处理的。</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JudgeManager</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行判题</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> judgeContext</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    JudgeInfo <span class="title function_">doJudge</span><span class="params">(JudgeContext judgeContext)</span> &#123;</span><br><span class="line">        <span class="type">QuestionSubmit</span> <span class="variable">questionSubmit</span> <span class="operator">=</span> judgeContext.getQuestionSubmit();</span><br><span class="line">        <span class="type">String</span> <span class="variable">language</span> <span class="operator">=</span> questionSubmit.getLanguage();</span><br><span class="line">        <span class="type">JudgeStrategy</span> <span class="variable">judgeStrategy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultJudgeStrategy</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;java&quot;</span>.equals(language)) &#123;</span><br><span class="line">            judgeStrategy = <span class="keyword">new</span> <span class="title class_">JavaLanguageJudgeStrategy</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> judgeStrategy.doJudge(judgeContext);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="模板方法模式">模板方法模式</h2><p>定义一个模板方法抽象类。</p><p>先复制具体的实现类，把代码从完整的方法抽离成一个个子方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Java 代码沙箱模板方法的实现</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">JavaCodeSandboxTemplate</span> <span class="keyword">implements</span> <span class="title class_">CodeSandbox</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GLOBAL_CODE_DIR_NAME</span> <span class="operator">=</span> <span class="string">&quot;tmpCode&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">GLOBAL_JAVA_CLASS_NAME</span> <span class="operator">=</span> <span class="string">&quot;Main.java&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">TIME_OUT</span> <span class="operator">=</span> <span class="number">5000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExecuteCodeResponse <span class="title function_">executeCode</span><span class="params">(ExecuteCodeRequest executeCodeRequest)</span> &#123;</span><br><span class="line">        List&lt;String&gt; inputList = executeCodeRequest.getInputList();</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> executeCodeRequest.getCode();</span><br><span class="line">        <span class="type">String</span> <span class="variable">language</span> <span class="operator">=</span> executeCodeRequest.getLanguage();</span><br><span class="line"></span><br><span class="line"><span class="comment">//        1. 把用户的代码保存为文件</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">userCodeFile</span> <span class="operator">=</span> saveCodeToFile(code);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        2. 编译代码，得到 class 文件</span></span><br><span class="line">        <span class="type">ExecuteMessage</span> <span class="variable">compileFileExecuteMessage</span> <span class="operator">=</span> compileFile(userCodeFile);</span><br><span class="line">        System.out.println(compileFileExecuteMessage);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 执行代码，得到输出结果</span></span><br><span class="line">        List&lt;ExecuteMessage&gt; executeMessageList = runFile(userCodeFile, inputList);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        4. 收集整理输出结果</span></span><br><span class="line">        <span class="type">ExecuteCodeResponse</span> <span class="variable">outputResponse</span> <span class="operator">=</span> getOutputResponse(executeMessageList);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        5. 文件清理</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">b</span> <span class="operator">=</span> deleteFile(userCodeFile);</span><br><span class="line">        <span class="keyword">if</span> (!b) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;deleteFile error, userCodeFilePath = &#123;&#125;&quot;</span>, userCodeFile.getAbsolutePath());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> outputResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1. 把用户的代码保存为文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> code 用户代码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> File <span class="title function_">saveCodeToFile</span><span class="params">(String code)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userDir</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.dir&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">globalCodePathName</span> <span class="operator">=</span> userDir + File.separator + GLOBAL_CODE_DIR_NAME;</span><br><span class="line">        <span class="comment">// 判断全局代码目录是否存在，没有则新建</span></span><br><span class="line">        <span class="keyword">if</span> (!FileUtil.exist(globalCodePathName)) &#123;</span><br><span class="line">            FileUtil.mkdir(globalCodePathName);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 把用户的代码隔离存放</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">userCodeParentPath</span> <span class="operator">=</span> globalCodePathName + File.separator + UUID.randomUUID();</span><br><span class="line">        <span class="type">String</span> <span class="variable">userCodePath</span> <span class="operator">=</span> userCodeParentPath + File.separator + GLOBAL_JAVA_CLASS_NAME;</span><br><span class="line">        <span class="type">File</span> <span class="variable">userCodeFile</span> <span class="operator">=</span> FileUtil.writeString(code, userCodePath, StandardCharsets.UTF_8);</span><br><span class="line">        <span class="keyword">return</span> userCodeFile;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2、编译代码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userCodeFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ExecuteMessage <span class="title function_">compileFile</span><span class="params">(File userCodeFile)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">compileCmd</span> <span class="operator">=</span> String.format(<span class="string">&quot;javac -encoding utf-8 %s&quot;</span>, userCodeFile.getAbsolutePath());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Process</span> <span class="variable">compileProcess</span> <span class="operator">=</span> Runtime.getRuntime().exec(compileCmd);</span><br><span class="line">            <span class="type">ExecuteMessage</span> <span class="variable">executeMessage</span> <span class="operator">=</span> ProcessUtils.runProcessAndGetMessage(compileProcess, <span class="string">&quot;编译&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (executeMessage.getExitValue() != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;编译错误&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> executeMessage;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="comment">//            return getErrorResponse(e);</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3、执行文件，获得执行结果列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userCodeFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ExecuteMessage&gt; <span class="title function_">runFile</span><span class="params">(File userCodeFile, List&lt;String&gt; inputList)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userCodeParentPath</span> <span class="operator">=</span> userCodeFile.getParentFile().getAbsolutePath();</span><br><span class="line"></span><br><span class="line">        List&lt;ExecuteMessage&gt; executeMessageList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String inputArgs : inputList) &#123;</span><br><span class="line"><span class="comment">//            String runCmd = String.format(&quot;java -Xmx256m -Dfile.encoding=UTF-8 -cp %s Main %s&quot;, userCodeParentPath, inputArgs);</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">runCmd</span> <span class="operator">=</span> String.format(<span class="string">&quot;java -Xmx256m -Dfile.encoding=UTF-8 -cp %s Main %s&quot;</span>, userCodeParentPath, inputArgs);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Process</span> <span class="variable">runProcess</span> <span class="operator">=</span> Runtime.getRuntime().exec(runCmd);</span><br><span class="line">                <span class="comment">// 超时控制</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(TIME_OUT);</span><br><span class="line">                        System.out.println(<span class="string">&quot;超时了，中断&quot;</span>);</span><br><span class="line">                        runProcess.destroy();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).start();</span><br><span class="line">                <span class="type">ExecuteMessage</span> <span class="variable">executeMessage</span> <span class="operator">=</span> ProcessUtils.runProcessAndGetMessage(runProcess, <span class="string">&quot;运行&quot;</span>);</span><br><span class="line">                System.out.println(executeMessage);</span><br><span class="line">                executeMessageList.add(executeMessage);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;执行错误&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> executeMessageList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 4、获取输出结果</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> executeMessageList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> ExecuteCodeResponse <span class="title function_">getOutputResponse</span><span class="params">(List&lt;ExecuteMessage&gt; executeMessageList)</span> &#123;</span><br><span class="line">        <span class="type">ExecuteCodeResponse</span> <span class="variable">executeCodeResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecuteCodeResponse</span>();</span><br><span class="line">        List&lt;String&gt; outputList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// 取用时最大值，便于判断是否超时</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">maxTime</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (ExecuteMessage executeMessage : executeMessageList) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">errorMessage</span> <span class="operator">=</span> executeMessage.getErrorMessage();</span><br><span class="line">            <span class="keyword">if</span> (StrUtil.isNotBlank(errorMessage)) &#123;</span><br><span class="line">                executeCodeResponse.setMessage(errorMessage);</span><br><span class="line">                <span class="comment">// 用户提交的代码执行中存在错误</span></span><br><span class="line">                executeCodeResponse.setStatus(<span class="number">3</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            outputList.add(executeMessage.getMessage());</span><br><span class="line">            <span class="type">Long</span> <span class="variable">time</span> <span class="operator">=</span> executeMessage.getTime();</span><br><span class="line">            <span class="keyword">if</span> (time != <span class="literal">null</span>) &#123;</span><br><span class="line">                maxTime = Math.max(maxTime, time);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 正常运行完成</span></span><br><span class="line">        <span class="keyword">if</span> (outputList.size() == executeMessageList.size()) &#123;</span><br><span class="line">            executeCodeResponse.setStatus(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        executeCodeResponse.setOutputList(outputList);</span><br><span class="line">        <span class="type">JudgeInfo</span> <span class="variable">judgeInfo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JudgeInfo</span>();</span><br><span class="line">        judgeInfo.setTime(maxTime);</span><br><span class="line">        <span class="comment">// 要借助第三方库来获取内存占用，非常麻烦，此处不做实现</span></span><br><span class="line"><span class="comment">//        judgeInfo.setMemory();</span></span><br><span class="line">        executeCodeResponse.setJudgeInfo(judgeInfo);</span><br><span class="line">        <span class="keyword">return</span> executeCodeResponse;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 5、删除文件</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userCodeFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">deleteFile</span><span class="params">(File userCodeFile)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (userCodeFile.getParentFile() != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">userCodeParentPath</span> <span class="operator">=</span> userCodeFile.getParentFile().getAbsolutePath();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">del</span> <span class="operator">=</span> FileUtil.del(userCodeParentPath);</span><br><span class="line">            System.out.println(<span class="string">&quot;删除&quot;</span> + (del ? <span class="string">&quot;成功&quot;</span> : <span class="string">&quot;失败&quot;</span>));</span><br><span class="line">            <span class="keyword">return</span> del;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 6、获取错误响应</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> ExecuteCodeResponse <span class="title function_">getErrorResponse</span><span class="params">(Throwable e)</span> &#123;</span><br><span class="line">        <span class="type">ExecuteCodeResponse</span> <span class="variable">executeCodeResponse</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecuteCodeResponse</span>();</span><br><span class="line">        executeCodeResponse.setOutputList(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br><span class="line">        executeCodeResponse.setMessage(e.getMessage());</span><br><span class="line">        <span class="comment">// 表示代码沙箱错误</span></span><br><span class="line">        executeCodeResponse.setStatus(<span class="number">2</span>);</span><br><span class="line">        executeCodeResponse.setJudgeInfo(<span class="keyword">new</span> <span class="title class_">JudgeInfo</span>());</span><br><span class="line">        <span class="keyword">return</span> executeCodeResponse;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>接着子类可以继承模板方法</p><p>java原生代码沙箱实现，可以直接复用模板方法定义好的方法实现。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Java 原生代码沙箱实现（直接复用模板方法）</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaNativeCodeSandbox</span> <span class="keyword">extends</span> <span class="title class_">JavaCodeSandboxTemplate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> ExecuteCodeResponse <span class="title function_">executeCode</span><span class="params">(ExecuteCodeRequest executeCodeRequest)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.executeCode(executeCodeRequest);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>docker代码沙箱实现，根据需求重写模板方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JavaDockerCodeSandbox</span> <span class="keyword">extends</span> <span class="title class_">JavaCodeSandboxTemplate</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">TIME_OUT</span> <span class="operator">=</span> <span class="number">5000L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Boolean</span> <span class="variable">FIRST_INIT</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">JavaDockerCodeSandbox</span> <span class="variable">javaNativeCodeSandbox</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JavaDockerCodeSandbox</span>();</span><br><span class="line">        <span class="type">ExecuteCodeRequest</span> <span class="variable">executeCodeRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecuteCodeRequest</span>();</span><br><span class="line">        executeCodeRequest.setInputList(Arrays.asList(<span class="string">&quot;1 2&quot;</span>, <span class="string">&quot;1 3&quot;</span>));</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> ResourceUtil.readStr(<span class="string">&quot;testCode/simpleComputeArgs/Main.java&quot;</span>, StandardCharsets.UTF_8);</span><br><span class="line"><span class="comment">//        String code = ResourceUtil.readStr(&quot;testCode/unsafeCode/RunFileError.java&quot;, StandardCharsets.UTF_8);</span></span><br><span class="line"><span class="comment">//        String code = ResourceUtil.readStr(&quot;testCode/simpleCompute/Main.java&quot;, StandardCharsets.UTF_8);</span></span><br><span class="line">        executeCodeRequest.setCode(code);</span><br><span class="line">        executeCodeRequest.setLanguage(<span class="string">&quot;java&quot;</span>);</span><br><span class="line">        <span class="type">ExecuteCodeResponse</span> <span class="variable">executeCodeResponse</span> <span class="operator">=</span> javaNativeCodeSandbox.executeCode(executeCodeRequest);</span><br><span class="line">        System.out.println(executeCodeResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 3、创建容器，把文件复制到容器内</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> userCodeFile</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> inputList</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;ExecuteMessage&gt; <span class="title function_">runFile</span><span class="params">(File userCodeFile, List&lt;String&gt; inputList)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">userCodeParentPath</span> <span class="operator">=</span> userCodeFile.getParentFile().getAbsolutePath();</span><br><span class="line">        <span class="comment">// 获取默认的 Docker Client</span></span><br><span class="line">        <span class="type">DockerClient</span> <span class="variable">dockerClient</span> <span class="operator">=</span> DockerClientBuilder.getInstance().build();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拉取镜像</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">image</span> <span class="operator">=</span> <span class="string">&quot;openjdk:8-alpine&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span> (FIRST_INIT) &#123;</span><br><span class="line">            <span class="type">PullImageCmd</span> <span class="variable">pullImageCmd</span> <span class="operator">=</span> dockerClient.pullImageCmd(image);</span><br><span class="line">            <span class="type">PullImageResultCallback</span> <span class="variable">pullImageResultCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PullImageResultCallback</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(PullResponseItem item)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;下载镜像：&quot;</span> + item.getStatus());</span><br><span class="line">                    <span class="built_in">super</span>.onNext(item);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                pullImageCmd</span><br><span class="line">                        .exec(pullImageResultCallback)</span><br><span class="line">                        .awaitCompletion();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;拉取镜像异常&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;下载完成&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 创建容器</span></span><br><span class="line"></span><br><span class="line">        <span class="type">CreateContainerCmd</span> <span class="variable">containerCmd</span> <span class="operator">=</span> dockerClient.createContainerCmd(image);</span><br><span class="line">        <span class="type">HostConfig</span> <span class="variable">hostConfig</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HostConfig</span>();</span><br><span class="line">        hostConfig.withMemory(<span class="number">100</span> * <span class="number">1000</span> * <span class="number">1000L</span>);</span><br><span class="line">        hostConfig.withMemorySwap(<span class="number">0L</span>);</span><br><span class="line">        hostConfig.withCpuCount(<span class="number">1L</span>);</span><br><span class="line">        hostConfig.withSecurityOpts(Arrays.asList(<span class="string">&quot;seccomp=安全管理配置字符串&quot;</span>));</span><br><span class="line">        hostConfig.setBinds(<span class="keyword">new</span> <span class="title class_">Bind</span>(userCodeParentPath, <span class="keyword">new</span> <span class="title class_">Volume</span>(<span class="string">&quot;/app&quot;</span>)));</span><br><span class="line">        <span class="type">CreateContainerResponse</span> <span class="variable">createContainerResponse</span> <span class="operator">=</span> containerCmd</span><br><span class="line">                .withHostConfig(hostConfig)</span><br><span class="line">                .withNetworkDisabled(<span class="literal">true</span>)</span><br><span class="line">                .withReadonlyRootfs(<span class="literal">true</span>)</span><br><span class="line">                .withAttachStdin(<span class="literal">true</span>)</span><br><span class="line">                .withAttachStderr(<span class="literal">true</span>)</span><br><span class="line">                .withAttachStdout(<span class="literal">true</span>)</span><br><span class="line">                .withTty(<span class="literal">true</span>)</span><br><span class="line">                .exec();</span><br><span class="line">        System.out.println(createContainerResponse);</span><br><span class="line">        <span class="type">String</span> <span class="variable">containerId</span> <span class="operator">=</span> createContainerResponse.getId();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 启动容器</span></span><br><span class="line">        dockerClient.startContainerCmd(containerId).exec();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// docker exec keen_blackwell java -cp /app Main 1 3</span></span><br><span class="line">        <span class="comment">// 执行命令并获取结果</span></span><br><span class="line">        List&lt;ExecuteMessage&gt; executeMessageList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (String inputArgs : inputList) &#123;</span><br><span class="line">            <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">            String[] inputArgsArray = inputArgs.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">            String[] cmdArray = ArrayUtil.append(<span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;java&quot;</span>, <span class="string">&quot;-cp&quot;</span>, <span class="string">&quot;/app&quot;</span>, <span class="string">&quot;Main&quot;</span>&#125;, inputArgsArray);</span><br><span class="line">            <span class="type">ExecCreateCmdResponse</span> <span class="variable">execCreateCmdResponse</span> <span class="operator">=</span> dockerClient.execCreateCmd(containerId)</span><br><span class="line">                    .withCmd(cmdArray)</span><br><span class="line">                    .withAttachStderr(<span class="literal">true</span>)</span><br><span class="line">                    .withAttachStdin(<span class="literal">true</span>)</span><br><span class="line">                    .withAttachStdout(<span class="literal">true</span>)</span><br><span class="line">                    .exec();</span><br><span class="line">            System.out.println(<span class="string">&quot;创建执行命令：&quot;</span> + execCreateCmdResponse);</span><br><span class="line"></span><br><span class="line">            <span class="type">ExecuteMessage</span> <span class="variable">executeMessage</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecuteMessage</span>();</span><br><span class="line">            <span class="keyword">final</span> String[] message = &#123;<span class="literal">null</span>&#125;;</span><br><span class="line">            <span class="keyword">final</span> String[] errorMessage = &#123;<span class="literal">null</span>&#125;;</span><br><span class="line">            <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> <span class="number">0L</span>;</span><br><span class="line">            <span class="comment">// 判断是否超时</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">boolean</span>[] timeout = &#123;<span class="literal">true</span>&#125;;</span><br><span class="line">            <span class="type">String</span> <span class="variable">execId</span> <span class="operator">=</span> execCreateCmdResponse.getId();</span><br><span class="line">            <span class="type">ExecStartResultCallback</span> <span class="variable">execStartResultCallback</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ExecStartResultCallback</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">// 如果执行完成，则表示没超时</span></span><br><span class="line">                    timeout[<span class="number">0</span>] = <span class="literal">false</span>;</span><br><span class="line">                    <span class="built_in">super</span>.onComplete();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Frame frame)</span> &#123;</span><br><span class="line">                    <span class="type">StreamType</span> <span class="variable">streamType</span> <span class="operator">=</span> frame.getStreamType();</span><br><span class="line">                    <span class="keyword">if</span> (StreamType.STDERR.equals(streamType)) &#123;</span><br><span class="line">                        errorMessage[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">String</span>(frame.getPayload());</span><br><span class="line">                        System.out.println(<span class="string">&quot;输出错误结果：&quot;</span> + errorMessage[<span class="number">0</span>]);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        message[<span class="number">0</span>] = <span class="keyword">new</span> <span class="title class_">String</span>(frame.getPayload());</span><br><span class="line">                        System.out.println(<span class="string">&quot;输出结果：&quot;</span> + message[<span class="number">0</span>]);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="built_in">super</span>.onNext(frame);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">final</span> <span class="type">long</span>[] maxMemory = &#123;<span class="number">0L</span>&#125;;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取占用的内存</span></span><br><span class="line">            <span class="type">StatsCmd</span> <span class="variable">statsCmd</span> <span class="operator">=</span> dockerClient.statsCmd(containerId);</span><br><span class="line">            ResultCallback&lt;Statistics&gt; statisticsResultCallback = statsCmd.exec(<span class="keyword">new</span> <span class="title class_">ResultCallback</span>&lt;Statistics&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onNext</span><span class="params">(Statistics statistics)</span> &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;内存占用：&quot;</span> + statistics.getMemoryStats().getUsage());</span><br><span class="line">                    maxMemory[<span class="number">0</span>] = Math.max(statistics.getMemoryStats().getUsage(), maxMemory[<span class="number">0</span>]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStart</span><span class="params">(Closeable closeable)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable throwable)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onComplete</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            statsCmd.exec(statisticsResultCallback);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stopWatch.start();</span><br><span class="line">                dockerClient.execStartCmd(execId)</span><br><span class="line">                        .exec(execStartResultCallback)</span><br><span class="line">                        .awaitCompletion(TIME_OUT, TimeUnit.MICROSECONDS);</span><br><span class="line">                stopWatch.stop();</span><br><span class="line">                time = stopWatch.getLastTaskTimeMillis();</span><br><span class="line">                statsCmd.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;程序执行异常&quot;</span>);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">            &#125;</span><br><span class="line">            executeMessage.setMessage(message[<span class="number">0</span>]);</span><br><span class="line">            executeMessage.setErrorMessage(errorMessage[<span class="number">0</span>]);</span><br><span class="line">            executeMessage.setTime(time);</span><br><span class="line">            executeMessage.setMemory(maxMemory[<span class="number">0</span>]);</span><br><span class="line">            executeMessageList.add(executeMessage);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> executeMessageList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></div><div class="kratos-copyright text-center clearfix"><h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5></div><footer class="kratos-entry-footer clearfix"><div class="post-like-donate text-center clearfix" id="post-like-donate"><a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a><div class="share-wrap" style="display:none"><div class="share-group"><a href="javascript:;" class="share-plain qq" onclick='share("qq")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-qq"></i></div></a><a href="javascript:;" class="share-plain qzone" onclick='share("qzone")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-star"></i></div></a><a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow"><div class="icon-wrap"><i class="fa fa-weixin"></i></div><div class="share-int"><div class="qrcode" id="wechat-qr"></div><p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p></div></a><a href="javascript:;" class="share-plain weibo" onclick='share("weibo")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-weibo"></i></div></a><a href="javascript:;" class="share-plain facebook style-plain" onclick='share("facebook")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-facebook"></i></div></a><a href="javascript:;" class="share-plain twitter style-plain" onclick='share("twitter")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-twitter"></i></div></a></div><script type="text/javascript">$(()=>{
            new QRCode("wechat-qr", {
                text: "https://moduokesi.top/2024/02/08/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://moduokesi.top/2024/02/08/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/";
            const title         = "「常见的设计模式」";
            const excerpt       = `单例模式
懒汉式
通常使用双重校验+锁的方式实现
volatile关键字可防止指令重排，比如创建一个对象，JVM会分为三步：


为singleton分配内存空间
初始化singleton对象
将singleton指向...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };</script></div></div><div class="footer-tag clearfix"><div class="pull-left"><i class="fa fa-tags"></i> <a class="tag-none-link" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag">学习笔记</a>, <a class="tag-none-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></div><div class="pull-date"><time datetime="2024-02-22T03:22:44.098Z" itemprop="dateModified">最后编辑：2024-02-22</time></div></div></footer></div><nav class="navigation post-navigation clearfix" role="navigation"><div class="nav-previous clearfix"><a title=" SpringSecurity+Redis+Jwt实战运用" href="/2024/01/18/SpringSecurity实战运用/">&lt; 上一篇</a></div><div class="nav-next clearfix"><a title=" 【项目开发】Java调用Python方法一文详解" href="/2024/04/26/【项目开发】Java调用Python方法/">下一篇 &gt;</a></div></nav></article></section><section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm"><aside id="krw-about" class="widget widget-kratos-about clearfix"><div class="photo-background"></div><div class="photo-wrapper clearfix"><div class="photo-wrapper-tip text-center"><img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto"></div></div><div class="textwidget"><p class="text-center"></p></div><div class="site-meta"><a class="meta-item" href="/archives/"><span class="title">文章 </span><span class="count">15 </span></a><a class="meta-item" href="/categories/"><span class="title">分类 </span><span class="count">7 </span></a><a class="meta-item" href="/tags/"><span class="title">标签 </span><span class="count">11</span></a></div></aside><div class="sticky-area"><aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class"><div class="photo-background"></div><h4 class="widget-title no-after"><i class="fa fa-compass"></i> 文章目录 <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span></h4><div class="textwidget"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F"><span class="toc-text">单例模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%87%92%E6%B1%89%E5%BC%8F"><span class="toc-text">懒汉式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A5%BF%E6%B1%89%E5%BC%8F"><span class="toc-text">饿汉式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%8E%82%E6%A8%A1%E5%BC%8F"><span class="toc-text">工厂模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F"><span class="toc-text">代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AD%96%E7%95%A5%E6%A8%A1%E5%BC%8F"><span class="toc-text">策略模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A8%A1%E6%9D%BF%E6%96%B9%E6%B3%95%E6%A8%A1%E5%BC%8F"><span class="toc-text">模板方法模式</span></a></li></ol></div></aside><aside id="krw-categories" class="widget widget-kratos-categories clearfix"><h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">项目开发</a><span class="category-list-count">2</span></li></ul></aside><aside id="krw-tags" class="widget widget-kratos-tags clearfix"><h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4><div class="tag-clouds"><a href="/tags/RabbitMQ/" style="font-size:.6em">RabbitMQ</a> <a href="/tags/%E5%A4%9A%E7%BA%BF%E7%A8%8B/" style="font-size:.6em">多线程</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" style="font-size:.7em">学习笔记</a> <a href="/tags/%E5%AF%86%E7%A0%81%E5%8A%A0%E5%AF%86/" style="font-size:.6em">密码加密</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/" style="font-size:.6em">数据复制</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size:.6em">设计模式</a> <a href="/tags/%E8%B5%9B%E9%A2%98%E5%88%86%E6%9E%90/" style="font-size:.6em">赛题分析</a> <a href="/tags/%E8%BA%AB%E4%BB%BD%E6%A0%A1%E9%AA%8C/" style="font-size:.6em">身份校验</a> <a href="/tags/%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3/" style="font-size:.7em">问题解决</a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/" style="font-size:.6em">项目开发</a> <a href="/tags/%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86/" style="font-size:.8em">项目管理</a></div></aside><aside id="krw-posts" class="widget widget-kratos-posts"><h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4><div class="tab-content"><ul class="list-group"><a class="list-group-item" href="/2024/07/08/%E3%80%90SpringBoot%E3%80%91%E9%9A%8F%E6%9C%BA%E7%9B%90%E5%80%BC+%E5%8F%8C%E9%87%8DSHA256%E5%8A%A0%E5%AF%86%E5%AE%9E%E6%88%98/"><i class="fa fa-book"></i> 【SpringBoot】随机盐值+双重SHA256加密实战</a> <a class="list-group-item" href="/2024/06/30/%E3%80%90%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E3%80%91RabbitMQ%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5/"><i class="fa fa-book"></i> 【消息队列】RabbitMQ基本概念</a> <a class="list-group-item" href="/2024/05/27/%E3%80%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E3%80%91%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8F%82%E6%95%B0%E5%8F%8A%E5%88%9B%E5%BB%BA%E6%96%B9%E6%B3%95/"><i class="fa fa-book"></i> 【并发编程】线程池参数及创建方法</a> <a class="list-group-item" href="/2024/05/05/%E3%80%90SpringBoot%E3%80%91MapStruct%E5%AE%9E%E7%8E%B0%E4%BC%98%E9%9B%85%E7%9A%84%E6%95%B0%E6%8D%AE%E5%A4%8D%E5%88%B6/"><i class="fa fa-book"></i> 【SpringBoot】MapStruct实现优雅的数据复制</a> <a class="list-group-item" href="/2024/04/26/%E3%80%90%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91%E3%80%91Java%E8%B0%83%E7%94%A8Python%E6%96%B9%E6%B3%95/"><i class="fa fa-book"></i> 【项目开发】Java调用Python方法一文详解</a></ul></div></aside></div></section></div></div></div><footer><div id="footer" class="ap-lrc"><div class="container"><div class="row"><div class="col-md-6 col-md-offset-3 footer-list text-center"><ul class="kratos-social-icons"><li><a target="_blank" rel="nofollow" href="https://weibo.com/u/https://weibo.com/u/7728377351"><i class="fa fa-weibo"></i></a></li><li><a href="mailto:modoxlixin@outlook.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="nofollow" href="https://github.com/moduokesi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="nofollow" href="/atom.xml"><i class="fa fa-rss"></i></a></li></ul><ul class="kratos-copyright"><div><li>&copy; 2024 Modox's blog 版权所有.</li><li>本站已运行<span id="span_dt">Loading...</span></li></div><div><li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li><li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Modox.</li></div><div><li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li><li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li></div><div></div></ul></div></div></div><div class="kr-tool text-center"><div class="tool"><div class="box search-box"><a href="/search/"><span class="fa fa-search"></span></a></div><div class="box theme-box" id="darkmode-switch"><span class="fa fa-adjust"></span></div></div><div class="box gotop-box"><span class="fa fa-chevron-up"></span></div></div></div></footer></div></div><script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script><script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script><script>window.kr||(window.kr={}),window.kr.notMobile=!navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),window.kr.siteRoot="/"</script><div><canvas id="snow"></canvas><script async src="/js/snow.min.js"></script></div><script async src="/js/candy.min.js"></script><script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script><script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script><meting-js server="netease" type="playlist" id="3204190542" order="random" fixed="true"></meting-js><script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script><script defer src="/js/kratosr.min.js"></script><script defer src="/js/pjax.min.js"></script></body></html>