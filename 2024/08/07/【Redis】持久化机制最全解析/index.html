<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><link rel="icon" href="/images/logo.png"><title>【Redis】持久化机制最全解析 | Modox&#39;s blog</title><meta name="author" content="Modox"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="robots" content="index,follow"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="format-detection" content="telphone=no, email=no"><meta name="keywords" content="AOF, RDB"><meta name="description" content="RDB持久化 RDB全称Redis Database Backup file（Redis数据备份文件）。通过将Redis数据集的快照保存到磁盘上的二进制文件中来实现。生成 RDB 文件的过程可以通过手动命令或自动触发。 实现原理 开始 BGSAVE：  Redis 主进程接收到 BGSAVE 命令后，调用 fork 创建一个子进程，子进程会先复制主进程的页表（记录虚拟地址与物理地"><meta property="og:type" content="article"><meta property="og:title" content="【Redis】持久化机制最全解析"><meta property="og:url" content="https://moduokesi.top/2024/08/07/%E3%80%90Redis%E3%80%91%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6%E6%9C%80%E5%85%A8%E8%A7%A3%E6%9E%90/index.html"><meta property="og:site_name" content="Modox&#39;s blog"><meta property="og:description" content="RDB持久化 RDB全称Redis Database Backup file（Redis数据备份文件）。通过将Redis数据集的快照保存到磁盘上的二进制文件中来实现。生成 RDB 文件的过程可以通过手动命令或自动触发。 实现原理 开始 BGSAVE：  Redis 主进程接收到 BGSAVE 命令后，调用 fork 创建一个子进程，子进程会先复制主进程的页表（记录虚拟地址与物理地"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://moduokesi.top/images/logo.png"><meta property="article:published_time" content="2024-08-07T03:57:33.000Z"><meta property="article:modified_time" content="2024-08-21T06:16:58.842Z"><meta property="article:author" content="Modox"><meta property="article:tag" content="RDB"><meta property="article:tag" content="AOF"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://moduokesi.top/images/logo.png"><link rel="alternate" href="atom.xml" type="application/atom+xml"><link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"><link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme:dark)"><script src="/js/kr-dark.min.js"></script><link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"><link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"><link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"><link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"><link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script><script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script><style>.kratos-cover.kratos-cover-2{background-image:url(/images/banner.webp)}@media(min-width:768px){body.custom-background{background-image:url(/images/bg.webp)}}</style><meta name="generator" content="Hexo 6.2.0"></head><body class="custom-background"><div id="kratos-wrapper"><div id="kratos-page"><div id="kratos-header"><header id="kratos-desktop-topnav" class="kratos-topnav"><div class="container"><div class="nav-header"><nav id="kratos-menu-wrap"><ul id="kratos-primary-menu" class="sf-menu"><li><a href="/"><i class="fa fa-home"></i> 首页</a></li><li><a href="/archives/"><i class="fa fa-file"></i> 档案馆</a></li><li><a><i class="fa fa-paw"></i> 友站</a><ul class="sub-menu"><li><a target="_blank" rel="noopener" href="https://penty7710.github.io/">pety's blog</a></li></ul></li><li><a><i class="fa fa-link"></i> 链接</a><ul class="sub-menu"><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/k123456kah?type=blog">CSDN</a></li><li><a target="_blank" rel="noopener" href="https://bbs.huaweicloud.com/community/usersnew/id_1670078149364456">华为云</a></li><li><a target="_blank" rel="noopener" href="https://gitee.com/moduokesi_admin">Gitee</a></li><li><a target="_blank" rel="noopener" href="https://github.com/moduokesi">GitHub</a></li></ul></li></ul></nav></div></div></header><header id="kratos-mobile-topnav" class="kratos-topnav"><div class="container"><div class="color-logo"><a href="/">Modox&#39;s blog</a></div><div class="nav-toggle"><a class="kratos-nav-toggle js-kratos-nav-toggle"><i></i></a></div></div></header></div><div class="kratos-start kratos-hero-2"><div class="kratos-cover kratos-cover-2 text-center"><div class="desc desc2 animate-box"><a href="/"><h2>Modox&#39;s blog</h2><br><span></span></a></div></div></div><div id="kratos-blog-post"><div class="container"><div id="main" class="row"><section class="col-md-8"><article itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://moduokesi.top/2024/08/07/%E3%80%90Redis%E3%80%91%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6%E6%9C%80%E5%85%A8%E8%A7%A3%E6%9E%90/"><div class="kratos-hentry kratos-post-inner clearfix"><header class="kratos-entry-header"><h1 class="kratos-entry-title text-center" itemprop="name headline">【Redis】持久化机制最全解析</h1><ul class="kratos-post-meta text-center"><li><time datetime="2024-08-07T03:57:33.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-08-07</time></li><li itemprop="author" itemscope itemtype="https://schema.org/Person"><i class="fa fa-user"></i> 作者 <span itemprop="name">Modox</span></li><li><i class="fa fa-edit"></i> ~5.47K 字</li></ul></header><div class="kratos-post-content"><div id="expire-alert" class="alert alert-warning hidden" role="alert"><div class="icon"><i class="fa fa-warning"></i></div><div class="text"><p>本文最后编辑于 <time datetime="1724221018842"></time> 前，其中的内容可能需要更新。</p></div></div><div class="kratos-post-inner-toc toc-div-class"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#rdb%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">RDB持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%90%AF%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">手动启用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%90%AF%E7%94%A8"><span class="toc-number">1.3.</span> <span class="toc-text">定时启用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aof%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">AOF持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-1"><span class="toc-number">2.1.</span> <span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8aof"><span class="toc-number">2.2.</span> <span class="toc-text">启用AOF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc-number">2.3.</span> <span class="toc-text">刷盘策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99"><span class="toc-number">2.4.</span> <span class="toc-text">文件重写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9rdb%E5%92%8Caof"><span class="toc-number">3.</span> <span class="toc-text">如何选择RDB和AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rdbredis-database-file"><span class="toc-number">3.1.</span> <span class="toc-text">RDB（Redis Database File）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aofappend-only-file"><span class="toc-number">3.2.</span> <span class="toc-text">AOF（Append-Only File）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E6%AF%94%E8%BE%83"><span class="toc-number">3.3.</span> <span class="toc-text">综合比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B7%E5%90%88%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.</span> <span class="toc-text">混合持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-number">4.2.</span> <span class="toc-text">优缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E6%B7%B7%E5%90%88%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-number">4.3.</span> <span class="toc-text">启用混合持久化</span></a></li></ol></li></ol></div><hr><div itemprop="articleBody"><h2 id="rdb持久化">RDB持久化</h2><p>RDB全称Redis Database Backup file（Redis数据备份文件）。通过<strong>将Redis数据集的快照保存到磁盘上的二进制文件中来实现</strong>。生成 RDB 文件的过程可以通过手动命令或自动触发。</p><h3 id="实现原理">实现原理</h3><p><strong>开始 BGSAVE</strong>：</p><ul><li>Redis 主进程接收到 <code>BGSAVE</code> 命令后，调用 <code>fork</code> 创建一个子进程，子进程会先复制主进程的页表（记录虚拟地址与物理地址的映射关系），而不是立即复制实际的内存数据。</li><li>在 fork 完成后，父子进程共享相同的内存页，子进程负责生成 RDB 文件，主进程可以继续处理客户端请求。</li></ul><p><strong>生成 RDB 文件</strong>：</p><ul><li>子进程根据页表，扫描 Redis 数据集，将每个键值对序列化为二进制格式，并写入到临时 RDB 文件中。</li><li>序列化后的数据被写入到一个临时 RDB 文件中，以避免影响现有 RDB 文件的使用。</li><li><strong>写时复制（Copy-On-Write, COW）</strong>：<ul><li>在生成 RDB 文件的过程中，如果主进程执行了写操作（如插入、更新、删除数据），操作系统会触发写时复制机制。COW 机制会为被修改的内存页创建一个副本，并将写操作应用到这个副本上，而不是直接修改共享的内存页。</li><li>主进程在读取被修改的数据时，会从生成的副本中读取，而子进程则继续读取原始的内存页。这种机制确保了子进程在生成 RDB 文件时看到的是一致且稳定的数据快照，而主进程可以不受影响地继续处理新的写操作。</li></ul></li></ul><p><strong>完成 RDB 文件</strong>：</p><ul><li>子进程生成 RDB 文件后，将临时 RDB 文件重命名为正式的 RDB 文件，确保文件替换过程是原子的。</li></ul><p><img src="https://img-blog.csdnimg.cn/img_convert/fdf7b6cfd054243fcc3bc8a6070ccafa.png"></p><h3 id="手动启用">手动启用</h3><p>Redis 提供了以下两个命令来手动生成 RDB 快照文件：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">save # 同步保存操作，由Redis主进程来执行RDB，会阻塞所有命令</span><br><span class="line">bgsave # 开启子进程执行RDB，避免主进程受到影响</span><br></pre></td></tr></table></figure><blockquote><p>这里说 Redis 主线程而不是主进程的主要是因为 Redis 启动之后主要是通过单线程的方式完成主要的工作。如果你想将其描述为 Redis 主进程，也没毛病。</p></blockquote><h3 id="定时启用">定时启用</h3><p>可以通过配置文件中的 <code>save</code> 选项进行定时触发RDB持久化。</p><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">save <span class="number">900</span> <span class="number">1</span>	#在<span class="number">900</span>秒(<span class="number">15</span>分钟)之后，如果至少有<span class="number">1</span>个key发生变化，Redis就会自动触发bgsave命令创建快照。</span><br><span class="line"></span><br><span class="line">save <span class="number">300</span> <span class="number">10</span>	#在<span class="number">300</span>秒(<span class="number">5</span>分钟)之后，如果至少有<span class="number">10</span>个key发生变化，Redis就会自动触发bgsave命令创建快照。</span><br><span class="line"></span><br><span class="line">save <span class="number">60</span> <span class="number">10000</span>	#在<span class="number">60</span>秒(<span class="number">1</span>分钟)之后，如果至少有<span class="number">10000</span>个key发生变化，Redis就会自动触发bgsave命</span><br></pre></td></tr></table></figure><h2 id="aof持久化">AOF持久化</h2><p>AOF全称为Append Only File（追加文件）。通过<strong>将每次写操作记录到AOF文件中来实现</strong>。这种方式的特点是将 Redis 接收到的每个写命令都追加到文件末尾。</p><h3 id="实现原理-1">实现原理</h3><p>AOF 持久化功能的实现可以简单分为 5 步：</p><ol type="1"><li><strong>命令追加（append）</strong>：所有的写命令会追加到 AOF 缓冲区中。</li><li><strong>文件写入（write）</strong>：将 AOF 缓冲区的数据写入到 AOF 文件中。这一步需要调用<code>write</code>函数（系统调用），<code>write</code>将数据写入到了系统内核缓冲区之后直接返回了（延迟写）。</li><li><strong>文件同步（fsync）</strong>：AOF 缓冲区根据对应的持久化方式（ <code>fsync</code> 策略）向硬盘做同步操作。这一步需要调用 <code>fsync</code> 函数（系统调用）， <code>fsync</code> 针对单个文件操作，对其进行强制硬盘同步，<code>fsync</code> 将阻塞直到写入磁盘完成后返回，保证了数据持久化。</li><li><strong>文件重写（rewrite）</strong>：随着 AOF 文件越来越大，需要定期对 AOF 文件进行重写，达到压缩的目的。</li><li><strong>重启加载（load）</strong>：当 Redis 重启时，可以加载 AOF 文件进行数据恢复。</li></ol><p><img src="https://img-blog.csdnimg.cn/img_convert/13ba660a72aad283d70bc33744034be0.png"></p><h3 id="启用aof">启用AOF</h3><p>与快照持久化相比，AOF 持久化的实时性更好。默认情况下 Redis 没有开启 AOF（Redis 6.0 之后默认开启），可以通过 <code>appendonly</code> 参数开启：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否开启AOF，默认是no</span></span><br><span class="line">appendonly <span class="built_in">yes</span></span><br><span class="line"><span class="comment"># AOF文件的名称</span></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br></pre></td></tr></table></figure><h3 id="刷盘策略">刷盘策略</h3><p>开启 AOF 持久化后，每执行一条会更改 Redis 中数据的命令，Redis 就会将该命令写入到 AOF 缓冲区 <code>server.aof_buf</code> 中，然后再写入到系统内核缓冲区中，最后根据刷盘策略的配置来决定何时将系统内核缓冲区中的数据<strong>同步到硬盘</strong>中。</p><p>AOF的命令记录的频率也可以通过redis.conf文件来配置。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示每执行一次写命令，立即记录到AOF文件</span></span><br><span class="line">appendfsync always</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">写命令执行完先放入AOF缓冲区，然后表示每隔1秒将缓冲区数据写到A0F文件，是默认方案</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">写命令执行完先放入AOF缓冲区，由操作系统决定何时将缓冲区内容写回磁盘</span></span><br><span class="line">appendfsync no</span><br></pre></td></tr></table></figure><table><colgroup><col style="width:16%"><col style="width:16%"><col style="width:29%"><col style="width:37%"></colgroup><thead><tr class="header"><th>配置项</th><th>刷盘时机</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr class="odd"><td><strong>always</strong></td><td>同步刷盘</td><td>可靠性高，几乎不丢数据</td><td>性能影响大</td></tr><tr class="even"><td><strong>everysec</strong></td><td>每秒刷盘</td><td>性能适中</td><td>最多丢失1秒数据</td></tr><tr class="odd"><td><strong>no</strong></td><td>操作系统控制</td><td>性能最好</td><td>可靠性较差，可能丢失大量数据</td></tr></tbody></table><h3 id="文件重写">文件重写</h3><p>随着时间的推移，AOF 文件会因为不断追加写命令而变得越来越大，可能会导致磁盘空间不足和恢复速度变慢。可以<strong>通过重新生成一个新的 AOF 文件，将当前的数据集以最少的命令集记录下来，从而缩小文件大小</strong>。</p><p><img src="https://img-blog.csdnimg.cn/img_convert/29a69c0ba1e14d99d844b41736bb3387.png"></p><p>AOF 文件重写期间，Redis 还会维护一个 <strong>AOF 重写缓冲区</strong>，该缓冲区会在子进程创建新 AOF 文件期间，记录服务器执行的所有写命令。当子进程完成创建新 AOF 文件的工作之后，服务器会将重写缓冲区中的所有内容<strong>追加到新 AOF 文件的末尾</strong>，使得新的 AOF 文件保存的数据库状态与现有的数据库状态一致。最后，服务器用新的 AOF 文件替换旧的 AOF 文件，以此来完成 AOF 文件重写操作。</p><p>开启 AOF 重写功能，可以调用 <code>bgrewriteaof</code> 命令手动执行，也可以设置阈值进行自动执行。</p><ul><li><code>auto-aof-rewrite-min-size</code>：如果 AOF 文件大小小于该值，则不会触发 AOF 重写。默认值为 64 MB</li><li><code>auto-aof-rewrite-percentage</code>：执行 AOF 重写时，当前 AOF 大小和上一次重写时 AOF 大小的比值。如果当前 AOF 文件大小增加了这个百分比值，将触发 AOF 重写。将此值设置为 0 将禁用自动 AOF 重写。默认值为 100。</li></ul><blockquote><p><strong>AOF校验机制了解吗</strong></p></blockquote><p><strong>AOF 校验机制是 Redis 在启动时对 AOF 文件进行检查</strong>，以判断文件是否完整，是否有损坏或者丢失的数据。</p><p>这个机制的原理其实非常简单，就是通过使用一种叫做 <strong>校验和（checksum）</strong> 的数字来验证 AOF 文件。这个校验和是通过对整个 AOF 文件内容进行 CRC64 算法计算得出的数字。<strong>如果文件内容发生了变化，那么校验和也会随之改变</strong>。因此，Redis 在启动时会比较<strong>计算出的校验</strong>和与<strong>文件末尾保存的校验和</strong>（计算的时候会把最后一行保存校验和的内容给忽略掉），从而判断 AOF 文件是否完整。如果发现文件有问题，Redis 就会拒绝启动并提供相应的错误信息。</p><p>类似地，RDB 文件也有类似的校验机制来保证 RDB 文件的正确性，这里就不重复进行介绍了。</p><h2 id="如何选择rdb和aof">如何选择RDB和AOF</h2><h3 id="rdbredis-database-file">RDB（Redis Database File）</h3><p><strong>优点：</strong></p><ol type="1"><li><strong>持久化速度快</strong>：RDB 文件在持久化时会生成一个数据快照，可以快速地恢复大规模的数据集。</li><li><strong>文件较小</strong>：RDB 文件是二进制格式的，通常比 AOF 文件更小，占用的磁盘空间较少。</li><li><strong>恢复速度快</strong>：RDB 文件在恢复数据时，加载速度通常比 AOF 快，因为 RDB 文件是一个完整的数据快照，不需要逐条回放写操作。</li><li><strong>对性能影响小</strong>：RDB 持久化是通过子进程完成的，主进程可以继续处理客户端请求，因此对 Redis 性能影响较小。</li></ol><p><strong>缺点：</strong></p><ol type="1"><li><strong>数据丢失风险高</strong>：因为 RDB 持久化是定期执行的（如每隔几分钟或根据配置的触发条件），在上一次持久化到下一次持久化之间的数据可能会丢失。</li><li><strong>生成过程消耗资源</strong>：生成 RDB 文件需要 fork 子进程并占用一定的 CPU 和内存资源，特别是数据量大时会影响性能。</li></ol><h3 id="aofappend-only-file">AOF（Append-Only File）</h3><p><strong>优点：</strong></p><ol type="1"><li><strong>数据丢失风险低</strong>：AOF 通过追加日志记录每次写操作，可以更频繁地持久化数据（甚至可以做到每秒持久化一次），因此数据丢失的风险较低。</li><li><strong>可调的同步策略</strong>：AOF 提供了多种同步策略（如 <code>always</code>、<code>everysec</code> 和 <code>no</code>），可以根据需要在性能和数据安全性之间做权衡。</li><li><strong>更人性化</strong>：AOF 文件是可读的日志文件，方便人类阅读和分析，有助于调试和故障排查。</li></ol><p><strong>缺点：</strong></p><ol type="1"><li><strong>文件较大</strong>：AOF 文件记录了每个写操作，文件大小通常比 RDB 大很多，占用更多的磁盘空间。</li><li><strong>恢复速度慢</strong>：AOF 恢复数据时需要回放所有的写操作日志，恢复速度通常比 RDB 慢。</li><li><strong>性能开销较大</strong>：因为 AOF 需要在每次写操作后追加日志，频繁的磁盘 I/O 操作会带来一定的性能开销，特别是在同步策略设置为 <code>always</code> 时。</li></ol><h3 id="综合比较">综合比较</h3><ol type="1"><li><strong>数据安全性</strong>：AOF 提供更高的数据安全性，适用于对数据丢失敏感的场景；RDB 在数据持久化频率较低时有较高的数据丢失风险。</li><li><strong>性能</strong>：RDB 对 Redis 性能影响较小，适用于性能要求高的场景；AOF 因为频繁的磁盘 I/O 操作，对性能有一定的影响。</li><li><strong>恢复速度</strong>：RDB 恢复速度更快，适用于需要快速恢复大规模数据集的场景；AOF 需要回放日志，恢复速度较慢。</li><li><strong>磁盘空间</strong>：RDB 文件较小，节省磁盘空间；AOF 文件较大，占用更多磁盘空间。</li></ol><h2 id="混合持久化">混合持久化</h2><p>Redis 4.0 引入了混合持久化机制，结合了 RDB 和 AOF 的优点，以提高持久化的效率和可靠性。<strong>混合持久化在重启恢复数据时使用 RDB 文件的快照来快速加载数据，并且将 AOF 日志应用于此快照以实现更高的数据恢复精度。</strong></p><h3 id="工作原理">工作原理</h3><ol type="1"><li><strong>RDB 快照</strong>：<ul><li>Redis 生成 RDB 文件快照，保存整个数据库的二进制数据。</li><li>RDB 文件的生成是通过子进程完成的，主进程可以继续处理客户端请求。</li></ul></li><li><strong>AOF 日志</strong>：<ul><li>除了生成 RDB 文件外，Redis 还会将写操作记录到 AOF 日志中。</li><li>在混合持久化模式下，AOF 文件的初始部分是一个 RDB 快照，后面紧接着的是增量的 AOF 日志。</li></ul></li><li><strong>持久化过程</strong>：<ul><li>当 Redis 进行持久化操作时，它会首先生成一个 RDB 文件，并将这个文件内容写入 AOF 文件。</li><li>在 AOF 文件中，RDB 文件的内容作为初始部分，然后紧跟着追加的 AOF 日志。</li></ul></li><li><strong>数据恢复</strong>：<ul><li>当 Redis 重启时，它会首先加载 AOF 文件中的 RDB 部分（即快照）来快速恢复数据。</li><li>然后，它会回放 AOF 文件中 RDB 部分后的增量日志，以确保数据的一致性和完整性。</li></ul></li></ol><h3 id="优缺点">优缺点</h3><p><strong>优点：</strong></p><ol type="1"><li><strong>快速恢复</strong>：使用 RDB 部分可以快速加载大部分数据，而不需要逐条回放所有写操作日志，极大地提高了数据恢复的速度。</li><li><strong>较高的数据安全性</strong>：结合了 RDB 和 AOF 的优点，RDB 部分确保了数据的快速恢复，而 AOF 部分提供了更高的数据持久化频率，降低了数据丢失的风险。</li><li><strong>性能优化</strong>：<ul><li>在持久化过程中，RDB 快照的生成是通过子进程完成的，对主进程处理客户端请求的性能影响较小。</li><li>AOF 的增量日志记录了自上次快照以来的所有写操作，减少了持久化过程中的 I/O 操作次数，提高了系统性能。</li></ul></li></ol><p><strong>缺点：</strong></p><ol type="1"><li><strong>配置复杂性</strong>：混合持久化的配置比单独使用 RDB 或 AOF 更加复杂，需要合理设置参数以实现最佳性能和数据安全性。</li><li><strong>磁盘空间占用</strong>：混合持久化模式下，AOF 文件既包含 RDB 快照部分又包含增量日志，可能会占用更多的磁盘空间。</li></ol><h3 id="启用混合持久化">启用混合持久化</h3><p>要启用混合持久化，可以在 Redis 配置文件 <code>redis.conf</code> 中设置以下参数：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用 AOF 持久化</span></span><br><span class="line">appendonly yes</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">AOF 重写策略</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在 AOF 文件达到指定大小或比例时触发重写</span></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用混合持久化</span></span><br><span class="line">aof-use-rdb-preamble yes</span><br></pre></td></tr></table></figure></div></div><div class="kratos-copyright text-center clearfix"><h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5></div><footer class="kratos-entry-footer clearfix"><div class="post-like-donate text-center clearfix" id="post-like-donate"><a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a><div class="share-wrap" style="display:none"><div class="share-group"><a href="javascript:;" class="share-plain qq" onclick='share("qq")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-qq"></i></div></a><a href="javascript:;" class="share-plain qzone" onclick='share("qzone")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-star"></i></div></a><a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow"><div class="icon-wrap"><i class="fa fa-weixin"></i></div><div class="share-int"><div class="qrcode" id="wechat-qr"></div><p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p></div></a><a href="javascript:;" class="share-plain weibo" onclick='share("weibo")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-weibo"></i></div></a><a href="javascript:;" class="share-plain facebook style-plain" onclick='share("facebook")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-facebook"></i></div></a><a href="javascript:;" class="share-plain twitter style-plain" onclick='share("twitter")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-twitter"></i></div></a></div><script type="text/javascript">$(()=>{
            new QRCode("wechat-qr", {
                text: "https://moduokesi.top/2024/08/07/%E3%80%90Redis%E3%80%91%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6%E6%9C%80%E5%85%A8%E8%A7%A3%E6%9E%90/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://moduokesi.top/2024/08/07/%E3%80%90Redis%E3%80%91%E6%8C%81%E4%B9%85%E5%8C%96%E6%9C%BA%E5%88%B6%E6%9C%80%E5%85%A8%E8%A7%A3%E6%9E%90/";
            const title         = "「【Redis】持久化机制最全解析」";
            const excerpt       = `RDB持久化
RDB全称Redis Database Backup
file（Redis数据备份文件）。通过将Redis数据集的快照保存到磁盘上的二进制文件中来实现。生成
RDB 文件的过程可以通过手动命令或自动触发。
实现原...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };</script></div></div><div class="footer-tag clearfix"><div class="pull-left"><i class="fa fa-tags"></i> <a class="tag-none-link" href="/tags/AOF/" rel="tag">AOF</a>, <a class="tag-none-link" href="/tags/RDB/" rel="tag">RDB</a></div><div class="pull-date"><time datetime="2024-08-21T06:16:58.842Z" itemprop="dateModified">最后编辑：2024-08-21</time></div></div></footer></div><nav class="navigation post-navigation clearfix" role="navigation"><div class="nav-previous clearfix"><a title=" 【MySQL】慢sql查询优化" href="/2024/08/04/【MySQL】慢sql查询优化/">&lt; 上一篇</a></div><div class="nav-next clearfix"><a title=" 【JVM】Java内存区域图文详解" href="/2024/08/07/【JVM】Java内存区域图文详解/">下一篇 &gt;</a></div></nav></article></section><section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm"><aside id="krw-about" class="widget widget-kratos-about clearfix"><div class="photo-background"></div><div class="photo-wrapper clearfix"><div class="photo-wrapper-tip text-center"><img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto"></div></div><div class="textwidget"><p class="text-center">华为云享专家<br>荣获多项国家级及省级荣誉<br>欢迎访问顶栏"链接"，关注更多技术内容</p></div><div class="site-meta"><a class="meta-item" href="/archives/"><span class="title">文章 </span><span class="count">35 </span></a><a class="meta-item" href="/categories/"><span class="title">分类 </span><span class="count">13 </span></a><a class="meta-item" href="/tags/"><span class="title">标签 </span><span class="count">43</span></a></div></aside><div class="sticky-area"><aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class"><div class="photo-background"></div><h4 class="widget-title no-after"><i class="fa fa-compass"></i> 文章目录 <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span></h4><div class="textwidget"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#rdb%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">RDB持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%8A%A8%E5%90%AF%E7%94%A8"><span class="toc-text">手动启用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%90%AF%E7%94%A8"><span class="toc-text">定时启用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#aof%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">AOF持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86-1"><span class="toc-text">实现原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8aof"><span class="toc-text">启用AOF</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%B7%E7%9B%98%E7%AD%96%E7%95%A5"><span class="toc-text">刷盘策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E9%87%8D%E5%86%99"><span class="toc-text">文件重写</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E9%80%89%E6%8B%A9rdb%E5%92%8Caof"><span class="toc-text">如何选择RDB和AOF</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rdbredis-database-file"><span class="toc-text">RDB（Redis Database File）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#aofappend-only-file"><span class="toc-text">AOF（Append-Only File）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%BC%E5%90%88%E6%AF%94%E8%BE%83"><span class="toc-text">综合比较</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B7%E5%90%88%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">混合持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="toc-text">优缺点</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E6%B7%B7%E5%90%88%E6%8C%81%E4%B9%85%E5%8C%96"><span class="toc-text">启用混合持久化</span></a></li></ol></li></ol></div></aside><aside id="krw-categories" class="widget widget-kratos-categories clearfix"><h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B8%B8%E7%94%A8%E9%9B%86%E5%90%88/">常用集合</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">项目开发</a><span class="category-list-count">5</span></li></ul></aside><aside id="krw-tags" class="widget widget-kratos-tags clearfix"><h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4><div class="tag-clouds"><a href="/tags/AOF/" style="font-size:.6em">AOF</a> <a href="/tags/AQS%E6%9C%BA%E5%88%B6/" style="font-size:.6em">AQS机制</a> <a href="/tags/ConcurrentHashMap/" style="font-size:.6em">ConcurrentHashMap</a> <a href="/tags/CountDownLatch/" style="font-size:.6em">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size:.6em">CyclicBarrier</a> <a href="/tags/HashMap/" style="font-size:.6em">HashMap</a> <a href="/tags/JIT/" style="font-size:.6em">JIT</a> <a href="/tags/Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/" style="font-size:.6em">Java内存区域</a> <a href="/tags/MVCC/" style="font-size:.6em">MVCC</a> <a href="/tags/MapStruct/" style="font-size:.6em">MapStruct</a> <a href="/tags/RDB/" style="font-size:.6em">RDB</a> <a href="/tags/RabbitMQ/" style="font-size:.8em">RabbitMQ</a> <a href="/tags/Redis/" style="font-size:.6em">Redis</a> <a href="/tags/Redisson/" style="font-size:.6em">Redisson</a> <a href="/tags/ReentrantLock/" style="font-size:.6em">ReentrantLock</a> <a href="/tags/Semaphore/" style="font-size:.6em">Semaphore</a> <a href="/tags/SpringBoot%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/" style="font-size:.6em">SpringBoot启动流程</a> <a href="/tags/starter%E6%9C%BA%E5%88%B6/" style="font-size:.6em">starter机制</a></div></aside><aside id="krw-posts" class="widget widget-kratos-posts"><h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4><div class="tab-content"><ul class="list-group"><a class="list-group-item" href="/2024/11/05/%E3%80%90%E5%88%86%E5%B8%83%E5%BC%8F%E3%80%91%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81%E8%AE%BE%E8%AE%A1/"><i class="fa fa-book"></i> 【分布式】分布式锁设计与Redisson源码解析</a> <a class="list-group-item" href="/2024/10/26/%E3%80%90SpringBoot%E3%80%91%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E2%80%94%E2%80%94%E5%90%AF%E5%8A%A8%E6%B5%81%E7%A8%8B/"><i class="fa fa-book"></i> 【SpringBoot】源码解析——启动流程</a> <a class="list-group-item" href="/2024/10/26/%E3%80%90SpringBoot%E3%80%91%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%E2%80%94%E2%80%94%E8%87%AA%E5%8A%A8%E8%A3%85%E9%85%8D%E4%B8%8Estarter%E6%9C%BA%E5%88%B6/"><i class="fa fa-book"></i> 【SpringBoot】源码解析——自动装配与starter机制</a> <a class="list-group-item" href="/2024/10/04/%E3%80%90Redis%E3%80%91%E6%B7%B1%E5%85%A5%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"><i class="fa fa-book"></i> 【Redis】深入五大数据类型</a> <a class="list-group-item" href="/2024/09/29/%E3%80%90%E5%B8%B8%E7%94%A8%E9%9B%86%E5%90%88%E3%80%91%E6%B7%B1%E5%85%A5%E6%B5%85%E5%87%BAMap%E9%9B%86%E5%90%88/"><i class="fa fa-book"></i> 【常用集合】深入浅出Map集合</a></ul></div></aside></div></section></div></div></div><footer><div id="footer" class="ap-lrc"><div class="container"><div class="row"><div class="col-md-6 col-md-offset-3 footer-list text-center"><ul class="kratos-social-icons"><li><a target="_blank" rel="nofollow" href="https://weibo.com/u/https://weibo.com/u/7728377351"><i class="fa fa-weibo"></i></a></li><li><a href="mailto:modoxlixin@outlook.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="nofollow" href="https://github.com/moduokesi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="nofollow" href="/atom.xml"><i class="fa fa-rss"></i></a></li></ul><ul class="kratos-copyright"><div><li>&copy; 2024 Modox's blog 版权所有.</li><li>本站已运行<span id="span_dt">Loading...</span></li></div><div><li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li><li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Modox.</li></div><div><li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li><li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li></div><div></div></ul></div></div></div><div class="kr-tool text-center"><div class="tool"><div class="box search-box"><a href="/search/"><span class="fa fa-search"></span></a></div><div class="box theme-box" id="darkmode-switch"><span class="fa fa-adjust"></span></div></div><div class="box gotop-box"><span class="fa fa-chevron-up"></span></div></div></div></footer></div></div><script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script><script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script><script>window.kr||(window.kr={}),window.kr.notMobile=!navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),window.kr.siteRoot="/"</script><div><canvas id="snow"></canvas><script async src="/js/snow.min.js"></script></div><script async src="/js/candy.min.js"></script><script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script><script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script><meting-js server="netease" type="playlist" id="3204190542" order="random" fixed="true"></meting-js><script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script><script defer src="/js/kratosr.min.js"></script><script defer src="/js/pjax.min.js"></script></body></html>