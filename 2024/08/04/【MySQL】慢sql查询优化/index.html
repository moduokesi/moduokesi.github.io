<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><link rel="icon" href="/images/logo.png"><title>【MySQL】慢sql查询优化 | Modox&#39;s blog</title><meta name="author" content="Modox"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="robots" content="index,follow"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="format-detection" content="telphone=no, email=no"><meta name="keywords" content="日志, 索引"><meta name="description" content="定位慢sql 工具排查慢sql  调试工具：Arthas 运维工具：Skywalking  通过以上工具可以看到哪个接口比较慢，并且可以分析SQL具体的执行时间，定位到哪个sql出了问题。 启用慢查询日志 慢查询日志记录了所有执行时间超过指定参数(long_query_time，单位:秒，默认10秒)的所有SQL语句的日志。 MySQL的慢查询日志默认没有开启，需要在MySQL的"><meta property="og:type" content="article"><meta property="og:title" content="【MySQL】慢sql查询优化"><meta property="og:url" content="https://moduokesi.top/2024/08/04/%E3%80%90MySQL%E3%80%91%E6%85%A2sql%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/index.html"><meta property="og:site_name" content="Modox&#39;s blog"><meta property="og:description" content="定位慢sql 工具排查慢sql  调试工具：Arthas 运维工具：Skywalking  通过以上工具可以看到哪个接口比较慢，并且可以分析SQL具体的执行时间，定位到哪个sql出了问题。 启用慢查询日志 慢查询日志记录了所有执行时间超过指定参数(long_query_time，单位:秒，默认10秒)的所有SQL语句的日志。 MySQL的慢查询日志默认没有开启，需要在MySQL的"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://moduokesi.top/images/logo.png"><meta property="article:published_time" content="2024-08-04T03:31:24.000Z"><meta property="article:modified_time" content="2024-08-04T09:31:20.531Z"><meta property="article:author" content="Modox"><meta property="article:tag" content="索引"><meta property="article:tag" content="日志"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://moduokesi.top/images/logo.png"><link rel="alternate" href="atom.xml" type="application/atom+xml"><link rel="stylesheet" id="kratos-css" href="/css/kratosr.min.css" media="all"><link rel="stylesheet" id="darkmode-css" href="/css/kr-color-dark.min.css" media="(prefers-color-scheme:dark)"><script src="/js/kr-dark.min.js"></script><link rel="stylesheet" id="highlight-css" href="/css/highlight/night-eighties.min.css" media="all"><link rel="stylesheet" id="fontawe-css" href="/vendors/font-awesome@4.7.0/css/font-awesome.min.css" media="all"><link rel="stylesheet" id="nprogress-css" href="/vendors/nprogress@0.2.0/nprogress.css" media="all"><link rel="stylesheet" href="/vendors/aplayer@1.10.1/dist/APlayer.min.css"><link rel="stylesheet" href="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css"><script src="/vendors/jquery@3.6.0/dist/jquery.min.js"></script><script src="/vendors/qrcode_js@1.0.0/qrcode.min.js"></script><style>.kratos-cover.kratos-cover-2{background-image:url(/images/banner.webp)}@media(min-width:768px){body.custom-background{background-image:url(/images/bg.webp)}}</style><meta name="generator" content="Hexo 6.2.0"></head><body class="custom-background"><div id="kratos-wrapper"><div id="kratos-page"><div id="kratos-header"><header id="kratos-desktop-topnav" class="kratos-topnav"><div class="container"><div class="nav-header"><nav id="kratos-menu-wrap"><ul id="kratos-primary-menu" class="sf-menu"><li><a href="/"><i class="fa fa-home"></i> 首页</a></li><li><a href="/archives/"><i class="fa fa-file"></i> 档案馆</a></li><li><a><i class="fa fa-paw"></i> 友站</a><ul class="sub-menu"><li><a target="_blank" rel="noopener" href="https://penty7710.github.io/">pety's blog</a></li></ul></li><li><a><i class="fa fa-link"></i> 链接</a><ul class="sub-menu"><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/k123456kah?type=blog">csdn</a></li><li><a target="_blank" rel="noopener" href="https://gitee.com/moduokesi_admin">gitee</a></li><li><a target="_blank" rel="noopener" href="https://github.com/moduokesi">github</a></li></ul></li></ul></nav></div></div></header><header id="kratos-mobile-topnav" class="kratos-topnav"><div class="container"><div class="color-logo"><a href="/">Modox&#39;s blog</a></div><div class="nav-toggle"><a class="kratos-nav-toggle js-kratos-nav-toggle"><i></i></a></div></div></header></div><div class="kratos-start kratos-hero-2"><div class="kratos-cover kratos-cover-2 text-center"><div class="desc desc2 animate-box"><a href="/"><h2>Modox&#39;s blog</h2><br><span></span></a></div></div></div><div id="kratos-blog-post"><div class="container"><div id="main" class="row"><section class="col-md-8"><article itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://moduokesi.top/2024/08/04/%E3%80%90MySQL%E3%80%91%E6%85%A2sql%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/"><div class="kratos-hentry kratos-post-inner clearfix"><header class="kratos-entry-header"><h1 class="kratos-entry-title text-center" itemprop="name headline">【MySQL】慢sql查询优化</h1><ul class="kratos-post-meta text-center"><li><time datetime="2024-08-04T03:31:24.000Z" itemprop="datePublished"><i class="fa fa-calendar"></i> 2024-08-04</time></li><li itemprop="author" itemscope itemtype="https://schema.org/Person"><i class="fa fa-user"></i> 作者 <span itemprop="name">Modox</span></li><li><i class="fa fa-edit"></i> ~4.88K 字</li></ul></header><div class="kratos-post-content"><div id="expire-alert" class="alert alert-warning hidden" role="alert"><div class="icon"><i class="fa fa-warning"></i></div><div class="text"><p>本文最后编辑于 <time datetime="1722763880531"></time> 前，其中的内容可能需要更新。</p></div></div><div class="kratos-post-inner-toc toc-div-class"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E6%85%A2sql"><span class="toc-number">1.</span> <span class="toc-text">定位慢sql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E6%8E%92%E6%9F%A5%E6%85%A2sql"><span class="toc-number">1.1.</span> <span class="toc-text">工具排查慢sql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.</span> <span class="toc-text">启用慢查询日志</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%85%A2sql"><span class="toc-number">2.</span> <span class="toc-text">分析慢sql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#profile%E8%AF%A6%E6%83%85"><span class="toc-number">2.1.</span> <span class="toc-text">profile详情</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#explain%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-number">2.2.</span> <span class="toc-text">explain执行计划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">2.2.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E9%87%8A%E6%84%8F"><span class="toc-number">2.2.2.</span> <span class="toc-text">字段释意</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#id"><span class="toc-number">2.2.2.1.</span> <span class="toc-text">id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select_type"><span class="toc-number">2.2.2.2.</span> <span class="toc-text">select_type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#table"><span class="toc-number">2.2.2.3.</span> <span class="toc-text">table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type%E9%87%8D%E8%A6%81"><span class="toc-number">2.2.2.4.</span> <span class="toc-text">type（重要）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#possible_keys"><span class="toc-number">2.2.2.5.</span> <span class="toc-text">possible_keys</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#key%E9%87%8D%E8%A6%81"><span class="toc-number">2.2.2.6.</span> <span class="toc-text">key（重要）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#extra%E9%87%8D%E8%A6%81"><span class="toc-number">2.2.2.7.</span> <span class="toc-text">Extra（重要）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%85%A2sql"><span class="toc-number">3.</span> <span class="toc-text">优化慢sql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sql%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-number">3.1.</span> <span class="toc-text">sql优化方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.</span> <span class="toc-text">深分页优化查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E5%88%86%E9%A1%B5"><span class="toc-number">3.2.1.</span> <span class="toc-text">传统分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5"><span class="toc-number">3.2.2.</span> <span class="toc-text">深分页</span></a></li></ol></li></ol></li></ol></div><hr><div itemprop="articleBody"><h1 id="定位慢sql">定位慢sql</h1><h2 id="工具排查慢sql">工具排查慢sql</h2><ul><li>调试工具：Arthas</li><li>运维工具：Skywalking</li></ul><p>通过以上工具可以看到哪个接口比较慢，并且可以分析SQL具体的执行时间，定位到哪个sql出了问题。</p><h2 id="启用慢查询日志">启用慢查询日志</h2><p>慢查询日志记录了所有执行时间超过指定参数(long_query_time，单位:秒，默认10秒)的所有SQL语句的日志。</p><p>MySQL的慢查询日志默认没有开启，需要在MySQL的配置文件(/etc/my.cnf)中配置如下信息:</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启MySQL慢日志查询开关</span></span><br><span class="line"><span class="string">slow_query_log=1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置慢日志的时间为1秒，SQL语句执行时间超过1秒，就会视为慢查询，记录到慢查询日志中</span></span><br><span class="line"><span class="string">long_query_time=2</span></span><br></pre></td></tr></table></figure><p>配置完成后，重启MySQL服务保证配置生效。</p><p>慢查询日志一般的返回结果如下：</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Time:2024-08-01T12:00:00.123456Z</span></span><br><span class="line"><span class="comment"># User@Host: root[root] @ localhost [] Id: 	8</span></span><br><span class="line"><span class="comment"># Query time:2.345678 Lock_time:0.012345 Rows sent:10 Rows examined: 100</span></span><br><span class="line"><span class="string">SET</span> <span class="string">timestamp=1650000000;</span></span><br><span class="line"><span class="string">SELECT</span> <span class="string">*</span> <span class="string">FROM</span> <span class="string">orders</span> <span class="string">WHERE</span> <span class="string">status</span> <span class="string">=&#x27;pending&quot;</span> <span class="string">ORDER</span> <span class="string">BY</span> <span class="string">gmt</span> <span class="string">created</span> <span class="string">DEsc;</span></span><br></pre></td></tr></table></figure><p>需要关注以下内容：</p><ul><li><p><strong>Query_time（查询时间）</strong>：查询执行的总时间，单位为秒。是关键的指标，用于判断查询的性能。</p></li><li><p><strong>Lock_time（锁定时间）</strong>：表被锁定的时间，单位为秒。可以帮助判断是否存在锁等待问题。</p></li><li><p><strong>Rows_sent（发送的行数）</strong>：查询返回的行数。</p></li><li><p><strong>Rows_examined（检查的行数）</strong>：查询过程中检查的行数，用于判断查询的效率。</p></li></ul><h1 id="分析慢sql">分析慢sql</h1><h2 id="profile详情">profile详情</h2><p><code>SHOW PROFILE</code> 是 MySQL 提供的一种用于查看查询语句执行的详细步骤和资源消耗的工具。使用 <code>SHOW PROFILE</code> 命令可以帮助找出查询语句的瓶颈，优化查询性能。</p><blockquote><p><strong>启用 Profiling</strong></p></blockquote><p>在使用 <code>SHOW PROFILE</code> 之前，需要先启用 Profiling：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET profiling = 1;</span><br></pre></td></tr></table></figure><blockquote><p><strong>执行查询</strong></p></blockquote><p>执行你想分析的查询语句：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM your_table WHERE some_column = &#x27;some_value&#x27;;</span><br></pre></td></tr></table></figure><blockquote><p><strong>查看 Profile 列表</strong></p></blockquote><p>使用以下命令查看刚才执行的查询的 Profile：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROFILES;</span><br></pre></td></tr></table></figure><p>这将显示一个查询 ID 列表及其对应的查询语句和总执行时间。</p><blockquote><p><strong>查看详细的 Profile 信息</strong></p></blockquote><p>使用 <code>SHOW PROFILE</code> 查看某个查询 ID 的详细信息：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROFILE FOR QUERY query_id;</span><br></pre></td></tr></table></figure><blockquote><p><strong>查看CPU信息</strong></p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW PROFILE CPU FOR QUERY query_id;</span><br></pre></td></tr></table></figure><h2 id="explain执行计划">explain执行计划</h2><p><code>explain</code> 是 MySQL 提供的一种用于分析和调试 SQL 查询的工具。</p><p>通过使用 <code>explain</code>，可以了解 MySQL 在执行查询时采用的具体执行计划，包括访问数据表的方式、使用的索引、连接表的顺序等信息。这些信息对于优化查询性能至关重要。</p><h3 id="基本概念">基本概念</h3><p><code>EXPLAIN</code> 执行计划支持 <code>SELECT</code>、<code>DELETE</code>、<code>INSERT</code>、<code>REPLACE</code> 以及 <code>UPDATE</code> 语句。我们一般多用于分析 <code>SELECT</code> 查询语句，要获取一条sql语句的执行计划，只需要在语句前加上<code>explain</code>关键字即可。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain + sql语句;</span><br></pre></td></tr></table></figure><p>执行计划的返回结果一般是这样的：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">+----+-------------+----------+------------+-------+-----------------+---------+---------+------+--------+----------+-------------+</span><br><span class="line">| id | select_type | table    | partitions | type  | possible_keys   | key     | key_len | ref  | rows   | filtered | Extra       |</span><br><span class="line">+----+-------------+----------+------------+-------+-----------------+---------+---------+------+--------+----------+-------------+</span><br><span class="line">|  1 | PRIMARY     | dept_emp | NULL       | ALL   | NULL            | NULL    | NULL    | NULL | 331143 |   100.00 | Using where |</span><br><span class="line">+----+-------------+----------+------------+-------+-----------------+---------+---------+------+--------+----------+-------------+</span><br></pre></td></tr></table></figure><p>返回结果中各字段的含义解释如下：</p><table><thead><tr class="header"><th>列名</th><th>含义</th></tr></thead><tbody><tr class="odd"><td>id</td><td>SELECT 查询的序列标识符</td></tr><tr class="even"><td>select_type</td><td>SELECT 关键字对应的查询类型</td></tr><tr class="odd"><td>table</td><td>用到的表名</td></tr><tr class="even"><td>partitions</td><td>匹配的分区，对于未分区的表，值为 NULL</td></tr><tr class="odd"><td>type</td><td>表的访问方法</td></tr><tr class="even"><td>possible_keys</td><td>可能用到的索引</td></tr><tr class="odd"><td>key</td><td>实际用到的索引</td></tr><tr class="even"><td>key_len</td><td>所选索引的长度</td></tr><tr class="odd"><td>ref</td><td>当使用索引等值查询时，与索引作比较的列或常量</td></tr><tr class="even"><td>rows</td><td>预计要读取的行数</td></tr><tr class="odd"><td>filtered</td><td>按表条件过滤后，留存的记录数的百分比</td></tr><tr class="even"><td>Extra</td><td>附加信息</td></tr></tbody></table><h3 id="字段释意">字段释意</h3><h4 id="id">id</h4><p>查询的序列标识符，用于表示查询的执行顺序。值越大，优先级越低，执行顺序越靠后。</p><h4 id="select_type">select_type</h4><p>查询的类型，主要用于区分普通查询、联合查询、子查询等复杂的查询，常见的值有：</p><ul><li><code>SIMPLE</code>: 简单查询，不包含子查询或 UNION。</li><li><code>PRIMARY</code>: 最外层的 SELECT 查询。</li><li><code>SUBQUERY</code>: 子查询中的第一个 SELECT。</li><li><code>DERIVED</code>: 派生表（子查询中的 FROM 子句）。</li><li><code>UNION</code>: UNION 操作中的第二个或后续的 SELECT 查询。</li><li><code>UNION RESULT</code>: UNION 的结果集。</li></ul><h4 id="table">table</h4><p>查询用到的表名。</p><h4 id="type重要">type（重要）</h4><p>查询执行的类型，描述了查询是如何执行的。常见的类型如下，这些类型的性能从最优到最差排序为：<code>system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL</code></p><ul><li><strong>system</strong>：如果表使用的引擎对于表行数统计是精确的（如：MyISAM），且表中只有一行记录的情况下，访问方法是 system ，是 const 的一种特例。</li><li><strong>const</strong>：表中最多只有一行匹配的记录，一次查询就可以找到，常用于使用主键或唯一索引的所有字段作为查询条件。</li><li><strong>eq_ref</strong>：当连表查询时，前一张表的行在当前这张表中只有一行与之对应。是除了 system 与 const 之外最好的 join 方式，常用于<strong>使用主键或唯一索引</strong>的所有字段作为连表条件。</li><li><strong>ref</strong>：使用普通索引作为查询条件，查询结果可能找到多个符合条件的行。</li><li><strong>range</strong>：对索引列进行范围查询，执行计划中的 key 列表示哪个索引被使用了。</li><li><strong>index</strong>：查询遍历了整棵索引树，与 ALL 类似，只不过扫描的是索引，而索引一般在内存中，速度更快。</li><li><strong>ALL</strong>：全表扫描。</li></ul><h4 id="possible_keys">possible_keys</h4><p>possible_keys 列表示 MySQL 执行查询时可能用到的索引。如果这一列为 NULL ，则表示没有索引可以使用。</p><h4 id="key重要">key（重要）</h4><p>key 列表示 MySQL 实际使用到的索引。如果为 NULL，则表示未用到索引。</p><h4 id="extra重要">Extra（重要）</h4><p>这列包含了 MySQL 解析查询的额外信息，通过这些信息，可以更准确的理解 MySQL 到底是如何执行查询的。常见的值如下：</p><ul><li><strong>Using index</strong>：表明查询使用了覆盖索引，不用回表，查询效率非常高。</li><li><strong>Using index condition</strong>：表示查询优化器选择使用了<strong>索引下推</strong>这个特性。</li><li><strong>Using where</strong>：表明查询使用了 WHERE 子句进行条件过滤。一般在没有使用到索引的时候会出现。</li><li><strong>Using filesort</strong>：在排序时使用了文件排序而不是索引排序，通常是因为无法使用索引进行排序。</li><li><strong>Using temporary</strong>：MySQL 需要创建临时表来存储查询的结果，常见于 ORDER BY 和 GROUP BY。</li><li><strong>Using join buffer (Block Nested Loop)</strong>：连表查询的方式，表示当被驱动表的没有使用索引的时候，MySQL 会先将驱动表读出来放到 join buffer 中，再遍历被驱动表与驱动表进行查询。</li></ul><h1 id="优化慢sql">优化慢sql</h1><h2 id="sql优化方案">sql优化方案</h2><p>根据<code>explain</code>执行计划的返回结果，我们可以根据以下字段进行sql优化：</p><ul><li>通过<code>key</code>和<code>key_len</code>检査<strong>是否命中了索引</strong>（索引本身存在是否有失效的情况）</li><li>通过<code>type</code>字段查看sql是否有进一步的优化空间，是否存在<strong>全索引扫描或全表扫描</strong></li><li>通过<code>extra</code>字段判断，是否出现了回表的情况，如果出现了，可以尝试添加索引或修改返回字段来修复</li></ul><h2 id="深分页优化查询">深分页优化查询</h2><h3 id="传统分页">传统分页</h3><p><strong>传统分页通常使用 <code>OFFSET</code> 和 <code>LIMIT</code> 来实现</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM table_name ORDER BY column_name LIMIT 10 OFFSET 1000;</span><br></pre></td></tr></table></figure><p>这种方法对于小数据集或页数较小时效果较好，但在数据量非常大的情况下，<code>OFFSET</code> 的值越大，数据库需要扫描的行数就越多，性能会急剧下降。</p><h3 id="深分页">深分页</h3><p><strong>深分页通过避免使用 <code>OFFSET</code> 来提高性能</strong></p><p><strong>1.覆盖索引+子查询：</strong> 这种方法<strong>通过子查询使用覆盖索引快速定位到分页的起始位置</strong>，外部查询从该位置获取实际数据，避免大量数据扫描和回表操作。</p><p>如本例中通过子查询定位到了第100001页的起始位置，向后获取100行数据。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM users WHERE id &gt; (SELECT id FROM users ORDER BY id LIMIT 100000, 1) LIMIT 100;</span><br></pre></td></tr></table></figure><p>这种方法避免了大量数据扫描，<strong>适用于有索引列</strong>的情况。</p><p><strong>2.存储分页结果：</strong> 另一种方法是将分页结果存储在缓存（如 Redis）或临时表中，从而避免频繁查询数据库。例如：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- 第一次查询并缓存结果</span><br><span class="line">SELECT * FROM table_name ORDER BY column_name LIMIT 1000;</span><br><span class="line">-- 将结果缓存起来，随后从缓存中进行分页</span><br></pre></td></tr></table></figure><p>这种方法<strong>适用于需要多次访问相同分页结果</strong>的场景。</p></div></div><div class="kratos-copyright text-center clearfix"><h5 itemprop="copyrightNotice">本作品采用 <a rel="license nofollow" target="_blank" href="https://creativecommons.org/licenses/by-sa/4.0/">知识共享署名-相同方式共享 4.0 国际许可协议</a> 进行许可</h5></div><footer class="kratos-entry-footer clearfix"><div class="post-like-donate text-center clearfix" id="post-like-donate"><a class="share" href="javascript:;"><i class="fa fa-share-alt"></i> 分享</a><div class="share-wrap" style="display:none"><div class="share-group"><a href="javascript:;" class="share-plain qq" onclick='share("qq")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-qq"></i></div></a><a href="javascript:;" class="share-plain qzone" onclick='share("qzone")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-star"></i></div></a><a href="javascript:;" class="share-plain weixin pop style-plain" rel="nofollow"><div class="icon-wrap"><i class="fa fa-weixin"></i></div><div class="share-int"><div class="qrcode" id="wechat-qr"></div><p>打开微信“扫一扫”，打开网页后点击屏幕右上角分享按钮</p></div></a><a href="javascript:;" class="share-plain weibo" onclick='share("weibo")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-weibo"></i></div></a><a href="javascript:;" class="share-plain facebook style-plain" onclick='share("facebook")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-facebook"></i></div></a><a href="javascript:;" class="share-plain twitter style-plain" onclick='share("twitter")' rel="nofollow"><div class="icon-wrap"><i class="fa fa-twitter"></i></div></a></div><script type="text/javascript">$(()=>{
            new QRCode("wechat-qr", {
                text: "https://moduokesi.top/2024/08/04/%E3%80%90MySQL%E3%80%91%E6%85%A2sql%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/",
                width: 150,
                height: 150,
                correctLevel : QRCode.CorrectLevel.H
            });
        });
        function share(dest) {
            const qqBase        = "https://connect.qq.com/widget/shareqq/index.html?";
            const weiboBase     = "https://service.weibo.com/share/share.php?";
            const qzoneBase     = "https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?";
            const facebookBase  = "https://www.facebook.com/sharer/sharer.php?";
            const twitterBase   = "https://twitter.com/intent/tweet?";
            const hostUrl       = "https://moduokesi.top/2024/08/04/%E3%80%90MySQL%E3%80%91%E6%85%A2sql%E6%9F%A5%E8%AF%A2%E4%BC%98%E5%8C%96/";
            const title         = "「【MySQL】慢sql查询优化」";
            const excerpt       = `定位慢sql
工具排查慢sql

调试工具：Arthas
运维工具：Skywalking

通过以上工具可以看到哪个接口比较慢，并且可以分析SQL具体的执行时间，定位到哪个sql出了问题。
启用慢查询日志
慢查询日志记...`;
            let _URL;
            switch (dest) {
                case "qq"       : _URL = qqBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";     break;
                case "weibo"    : _URL = weiboBase+"url="+hostUrl+"&title="+title+excerpt;                                 break;
                case "qzone"    : _URL = qzoneBase+"url="+hostUrl+"&title="+title+"&desc=&summary="+excerpt+"&site=cxpy";  break;
                case "facebook" : _URL = facebookBase+"u="+hostUrl;                                                        break;
                case "twitter"  : _URL = twitterBase+"text="+title+excerpt+"&url="+hostUrl;                                break;
            }
            window.open(_URL);
        };</script></div></div><div class="footer-tag clearfix"><div class="pull-left"><i class="fa fa-tags"></i> <a class="tag-none-link" href="/tags/%E6%97%A5%E5%BF%97/" rel="tag">日志</a>, <a class="tag-none-link" href="/tags/%E7%B4%A2%E5%BC%95/" rel="tag">索引</a></div><div class="pull-date"><time datetime="2024-08-04T09:31:20.531Z" itemprop="dateModified">最后编辑：2024-08-04</time></div></div></footer></div><nav class="navigation post-navigation clearfix" role="navigation"><div class="nav-previous clearfix"><a title=" 【MySQL】全面剖析索引失效、回表查询与索引下推" href="/2024/08/03/【MySQL】全面剖析索引失效、回表查询与索引下推/">&lt; 上一篇</a></div><div class="nav-next clearfix"><a title=" 【Redis】持久化机制最全解析" href="/2024/08/07/【Redis】持久化机制最全解析/">下一篇 &gt;</a></div></nav></article></section><section id="kratos-widget-area" class="col-md-4 hidden-xs hidden-sm"><aside id="krw-about" class="widget widget-kratos-about clearfix"><div class="photo-background"></div><div class="photo-wrapper clearfix"><div class="photo-wrapper-tip text-center"><img class="about-photo" src="/images/avatar.webp" loading="lazy" decoding="auto"></div></div><div class="textwidget"><p class="text-center"></p></div><div class="site-meta"><a class="meta-item" href="/archives/"><span class="title">文章 </span><span class="count">29 </span></a><a class="meta-item" href="/categories/"><span class="title">分类 </span><span class="count">10 </span></a><a class="meta-item" href="/tags/"><span class="title">标签 </span><span class="count">32</span></a></div></aside><div class="sticky-area"><aside id="krw-toc" class="widget widget-kratos-toc clearfix toc-div-class"><div class="photo-background"></div><h4 class="widget-title no-after"><i class="fa fa-compass"></i> 文章目录 <span class="toc-progress-bar" role="progressbar" aria-label="阅读进度："></span></h4><div class="textwidget"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9A%E4%BD%8D%E6%85%A2sql"><span class="toc-text">定位慢sql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B7%A5%E5%85%B7%E6%8E%92%E6%9F%A5%E6%85%A2sql"><span class="toc-text">工具排查慢sql</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E7%94%A8%E6%85%A2%E6%9F%A5%E8%AF%A2%E6%97%A5%E5%BF%97"><span class="toc-text">启用慢查询日志</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%86%E6%9E%90%E6%85%A2sql"><span class="toc-text">分析慢sql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#profile%E8%AF%A6%E6%83%85"><span class="toc-text">profile详情</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#explain%E6%89%A7%E8%A1%8C%E8%AE%A1%E5%88%92"><span class="toc-text">explain执行计划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E9%87%8A%E6%84%8F"><span class="toc-text">字段释意</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#id"><span class="toc-text">id</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#select_type"><span class="toc-text">select_type</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#table"><span class="toc-text">table</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#type%E9%87%8D%E8%A6%81"><span class="toc-text">type（重要）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#possible_keys"><span class="toc-text">possible_keys</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#key%E9%87%8D%E8%A6%81"><span class="toc-text">key（重要）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#extra%E9%87%8D%E8%A6%81"><span class="toc-text">Extra（重要）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E6%85%A2sql"><span class="toc-text">优化慢sql</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sql%E4%BC%98%E5%8C%96%E6%96%B9%E6%A1%88"><span class="toc-text">sql优化方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96%E6%9F%A5%E8%AF%A2"><span class="toc-text">深分页优化查询</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%A0%E7%BB%9F%E5%88%86%E9%A1%B5"><span class="toc-text">传统分页</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%B1%E5%88%86%E9%A1%B5"><span class="toc-text">深分页</span></a></li></ol></li></ol></li></ol></div></aside><aside id="krw-categories" class="widget widget-kratos-categories clearfix"><h4 class="widget-title"><i class="fa fa-folder"></i>分类目录</h4><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Git/">Git</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/JVM/">JVM</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/MySQL/">MySQL</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Redis/">Redis</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">并发编程</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%AF%94%E8%B5%9B/">比赛</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%A1%B9%E7%9B%AE%E5%BC%80%E5%8F%91/">项目开发</a><span class="category-list-count">5</span></li></ul></aside><aside id="krw-tags" class="widget widget-kratos-tags clearfix"><h4 class="widget-title"><i class="fa fa-tags"></i>标签聚合</h4><div class="tag-clouds"><a href="/tags/AOF/" style="font-size:.6em">AOF</a> <a href="/tags/AQS%E6%9C%BA%E5%88%B6/" style="font-size:.6em">AQS机制</a> <a href="/tags/CountDownLatch/" style="font-size:.6em">CountDownLatch</a> <a href="/tags/CyclicBarrier/" style="font-size:.6em">CyclicBarrier</a> <a href="/tags/JIT/" style="font-size:.6em">JIT</a> <a href="/tags/Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F/" style="font-size:.6em">Java内存区域</a> <a href="/tags/MVCC/" style="font-size:.6em">MVCC</a> <a href="/tags/MapStruct/" style="font-size:.6em">MapStruct</a> <a href="/tags/RDB/" style="font-size:.6em">RDB</a> <a href="/tags/RabbitMQ/" style="font-size:.8em">RabbitMQ</a> <a href="/tags/Redis/" style="font-size:.6em">Redis</a> <a href="/tags/ReentrantLock/" style="font-size:.6em">ReentrantLock</a> <a href="/tags/Semaphore/" style="font-size:.6em">Semaphore</a> <a href="/tags/%E4%B8%BB%E4%BB%8E%E9%9B%86%E7%BE%A4/" style="font-size:.6em">主从集群</a> <a href="/tags/%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/" style="font-size:.6em">代理模式</a> <a href="/tags/%E5%88%86%E7%89%87%E9%9B%86%E7%BE%A4/" style="font-size:.6em">分片集群</a> <a href="/tags/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F/" style="font-size:.6em">单例模式</a> <a href="/tags/%E5%93%A8%E5%85%B5%E6%9C%BA%E5%88%B6/" style="font-size:.6em">哨兵机制</a></div></aside><aside id="krw-posts" class="widget widget-kratos-posts"><h4 class="widget-title"><i class="fa fa-file"></i>最新文章</h4><div class="tab-content"><ul class="list-group"><a class="list-group-item" href="/2024/08/30/%E3%80%90%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B%E3%80%91%E4%BB%8EAQS%E6%9C%BA%E5%88%B6%E5%88%B0%E5%90%8C%E6%AD%A5%E5%B7%A5%E5%85%B7%E7%B1%BB/"><i class="fa fa-book"></i> 【并发编程】从AQS机制到同步工具类</a> <a class="list-group-item" href="/2024/08/21/%E3%80%90%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F%E3%80%91%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E8%AF%A6%E8%A7%A3/"><i class="fa fa-book"></i> 【设计模式】单例模式详解</a> <a class="list-group-item" href="/2024/08/12/%E3%80%90Redis%E9%9B%86%E7%BE%A4%E3%80%91%E6%B7%B1%E5%85%A5%E8%A7%A3%E6%9E%90%E9%9B%86%E7%BE%A4%E5%8E%9F%E7%90%86/"><i class="fa fa-book"></i> 【Redis集群】集群原理最全解析</a> <a class="list-group-item" href="/2024/08/08/%E3%80%90JVM%E3%80%91%E6%B7%B1%E5%85%A5JIT%E4%BC%98%E5%8C%96%E6%9C%BA%E5%88%B6/"><i class="fa fa-book"></i> 【JVM】深入JIT优化机制</a> <a class="list-group-item" href="/2024/08/07/%E3%80%90JVM%E3%80%91Java%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F%E5%9B%BE%E6%96%87%E8%AF%A6%E8%A7%A3/"><i class="fa fa-book"></i> 【JVM】Java内存区域图文详解</a></ul></div></aside></div></section></div></div></div><footer><div id="footer" class="ap-lrc"><div class="container"><div class="row"><div class="col-md-6 col-md-offset-3 footer-list text-center"><ul class="kratos-social-icons"><li><a target="_blank" rel="nofollow" href="https://weibo.com/u/https://weibo.com/u/7728377351"><i class="fa fa-weibo"></i></a></li><li><a href="mailto:modoxlixin@outlook.com"><i class="fa fa-envelope"></i></a></li><li><a target="_blank" rel="nofollow" href="https://github.com/moduokesi"><i class="fa fa-github"></i></a></li><li><a target="_blank" rel="nofollow" href="/atom.xml"><i class="fa fa-rss"></i></a></li></ul><ul class="kratos-copyright"><div><li>&copy; 2024 Modox's blog 版权所有.</li><li>本站已运行<span id="span_dt">Loading...</span></li></div><div><li>Theme <a href="https://github.com/Candinya/Kratos-Rebirth" target="_blank">Kratos:Rebirth</a></li><li>Site built with&nbsp;<i class="fa fa-heart throb" style="color:#d43f57"></i>&nbsp;by Modox.</li></div><div><li>Powered by <a href="https://hexo.io" target="_blank" rel="nofollow">Hexo</a></li><li>Hosted on <a href="https://github.io" target="_blank">Github Pages</a></li></div><div></div></ul></div></div></div><div class="kr-tool text-center"><div class="tool"><div class="box search-box"><a href="/search/"><span class="fa fa-search"></span></a></div><div class="box theme-box" id="darkmode-switch"><span class="fa fa-adjust"></span></div></div><div class="box gotop-box"><span class="fa fa-chevron-up"></span></div></div></div></footer></div></div><script defer src="/vendors/bootstrap@3.3.4/dist/js/bootstrap.min.js"></script><script defer src="/vendors/nprogress@0.2.0/nprogress.js"></script><script>window.kr||(window.kr={}),window.kr.notMobile=!navigator.userAgent.match(/(phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone)/i),window.kr.siteRoot="/"</script><div><canvas id="snow"></canvas><script async src="/js/snow.min.js"></script></div><script async src="/js/candy.min.js"></script><script defer src="/vendors/aplayer@1.10.1/dist/APlayer.min.js"></script><script defer src="/vendors/meting@2.0.1/dist/Meting.min.js"></script><meting-js server="netease" type="playlist" id="3204190542" order="random" fixed="true"></meting-js><script defer src="/vendors/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script><script defer src="/vendors/clipboard@2.0.6/dist/clipboard.min.js"></script><script defer src="/js/kratosr.min.js"></script><script defer src="/js/pjax.min.js"></script></body></html>